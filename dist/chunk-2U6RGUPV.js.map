{"version":3,"sources":["../src/utils/sync/mutexWithKey.ts"],"sourcesContent":["import { Mutex } from \"async-mutex\"\n\n/**\n * Provides per-key mutual exclusion using async-mutex.\n * This only works on a single thread.\n */\nexport class MutexWithKey {\n\tprivate static locks = new Map<string, Mutex>()\n\tprivate static creationMutex = new Mutex()\n\n\tstatic async withLock<T>(key: string, fn: () => Promise<T>): Promise<T> {\n\t\tlet mutex: Mutex\n\n\t\t// Ensure only one mutex is created per key\n\t\tawait this.creationMutex.runExclusive(() => {\n\t\t\tmutex = this.locks.get(key) ?? new Mutex()\n\t\t\tthis.locks.set(key, mutex)\n\t\t})\n\n\t\t// Run the actual function under the per-key mutex\n\t\treturn mutex!.runExclusive(fn)\n\t}\n}\n"],"mappings":";AAAA,SAAS,aAAa;AAMf,IAAM,eAAN,MAAmB;AAAA,EACzB,OAAe,QAAQ,oBAAI,IAAmB;AAAA,EAC9C,OAAe,gBAAgB,IAAI,MAAM;AAAA,EAEzC,aAAa,SAAY,KAAa,IAAkC;AACvE,QAAI;AAGJ,UAAM,KAAK,cAAc,aAAa,MAAM;AAC3C,cAAQ,KAAK,MAAM,IAAI,GAAG,KAAK,IAAI,MAAM;AACzC,WAAK,MAAM,IAAI,KAAK,KAAK;AAAA,IAC1B,CAAC;AAGD,WAAO,MAAO,aAAa,EAAE;AAAA,EAC9B;AACD;","names":[]}