{"version":3,"sources":["../src/storage/cloud-storage.ts"],"sourcesContent":["import { pipeline } from \"node:stream/promises\"\n\nimport { SaveData, Storage } from \"@google-cloud/storage\"\n\nimport { PrimitiveValue } from \"@/types\"\n\nimport { NotFoundError, ForbiddenError, SomethingWentWrong, BadRequestError } from \"../errors/errors\"\n\ntype FileUriInfo = {\n\tbucketName: string\n\tfilePath: string\n}\n\n// GCS Error interface\ninterface CloudStorageError extends Error {\n\tcode?: number\n}\n\n// Type guard for GCS errors\nfunction isGCSError(error: unknown): error is CloudStorageError {\n\treturn error != null && typeof error === \"object\" && \"code\" in error && typeof error.code === \"number\"\n}\n\nexport interface UploadOptions {\n\tcontentType?: string\n\tmetadata?: Record<string, PrimitiveValue>\n}\n\nexport interface UploadResult {\n\turi: string\n\tfileSize: number\n\tchecksumCrc32c: string | undefined\n\tchecksumMd5: string | undefined\n\tcontentType: string\n\tbucketName: string\n\tfilePath: string\n}\n\n/**\n * GCS Helper class for file operations\n */\nexport class CloudStorageService {\n\tconstructor(public readonly storage: Storage) {}\n\n\tasync getFileMetadata(fileUrl: string) {\n\t\ttry {\n\t\t\tconst info = CloudStorageService.extractInfo(fileUrl)\n\t\t\tif (!info) {\n\t\t\t\treturn null\n\t\t\t}\n\n\t\t\t// Get file metadata from GCS\n\t\t\t// https://cloud.google.com/storage/docs/samples/storage-get-metadata\n\t\t\tconst file = this.storage.bucket(info.bucketName).file(info.filePath)\n\t\t\tconst [fileExists] = await file.exists()\n\t\t\tif (!fileExists) {\n\t\t\t\treturn null\n\t\t\t}\n\t\t\tconst [metadata] = await file.getMetadata()\n\t\t\tif (!metadata.timeCreated) {\n\t\t\t\treturn null\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tbucketName: info.bucketName,\n\t\t\t\tfilePath: info.filePath,\n\t\t\t\tname: (metadata.name ?? info.filePath).split(\"/\").pop() ?? \"\",\n\t\t\t\tcontentType: metadata.contentType ?? \"application/octet-stream\",\n\t\t\t\tsize: Number(metadata.size ?? 0),\n\t\t\t\tchecksumCrc32c: metadata.crc32c,\n\t\t\t\tchecksumMd5: metadata.md5Hash,\n\t\t\t\tcreatedAt: new Date(metadata.timeCreated ?? 0),\n\t\t\t\tmodifiedAt: new Date(metadata.updated ?? 0),\n\t\t\t\twebUrl: metadata.mediaLink,\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tif (isGCSError(error)) {\n\t\t\t\tif (error.code === 404 || (error instanceof Error && error.message?.toLowerCase().includes(\"not found\"))) {\n\t\t\t\t\treturn null\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new SomethingWentWrong(`Failed to get file info: ${fileUrl}`, {\n\t\t\t\tcause: error,\n\t\t\t})\n\t\t}\n\t}\n\n\tasync download(fileUrl: string): Promise<Buffer> {\n\t\t// Check if it's a Google Cloud Storage URL\n\t\tconst info = CloudStorageService.extractInfo(fileUrl)\n\n\t\tif (info) {\n\t\t\t// Download from Cloud Storage\n\t\t\tconst bucket = this.storage.bucket(info.bucketName)\n\t\t\tconst file = bucket.file(info.filePath)\n\n\t\t\ttry {\n\t\t\t\tconst [content] = await file.download()\n\t\t\t\treturn content\n\t\t\t} catch (error: unknown) {\n\t\t\t\tif (isGCSError(error)) {\n\t\t\t\t\tif (error.code === 404 || (error instanceof Error && error.message?.toLowerCase().includes(\"not found\"))) {\n\t\t\t\t\t\tthrow new NotFoundError(`File not found in storage: gs://${info.bucketName}/${info.filePath}`, {\n\t\t\t\t\t\t\tcause: error,\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t\tif (error.code === 403) {\n\t\t\t\t\t\tthrow new ForbiddenError(`Access denied to file: gs://${info.bucketName}/${info.filePath}`, {\n\t\t\t\t\t\t\tcause: error,\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tthrow new SomethingWentWrong(`Failed to download from GCS: gs://${info.bucketName}/${info.filePath}`, {\n\t\t\t\t\tcause: error,\n\t\t\t\t})\n\t\t\t}\n\t\t} else {\n\t\t\t// Download directly via HTTP\n\t\t\tconst response = await fetch(fileUrl)\n\t\t\tif (!response.ok) {\n\t\t\t\tif (response.status === 404) {\n\t\t\t\t\tthrow new NotFoundError(`File not found: ${fileUrl}`)\n\t\t\t\t}\n\t\t\t\tif (response.status >= 400 && response.status < 500) {\n\t\t\t\t\tthrow new BadRequestError(\n\t\t\t\t\t\t`Failed to fetch file from ${fileUrl}: Got status code ${response.status} ${response.statusText}`,\n\t\t\t\t\t)\n\t\t\t\t}\n\t\t\t\tthrow new SomethingWentWrong(\n\t\t\t\t\t`Failed to fetch file from ${fileUrl}: Got status code ${response.status} ${response.statusText}`,\n\t\t\t\t)\n\t\t\t}\n\t\t\tconst arrayBuffer = await response.arrayBuffer()\n\t\t\treturn Buffer.from(arrayBuffer)\n\t\t}\n\t}\n\n\t/**\n\t * Upload new file to GCS\n\t */\n\tasync upload(\n\t\tbucketName: string,\n\t\tfilePath: string,\n\t\tcontent: SaveData,\n\t\toptions?: UploadOptions,\n\t): Promise<UploadResult> {\n\t\tconst file = this.storage.bucket(bucketName).file(filePath)\n\t\ttry {\n\t\t\tawait file.save(content, options)\n\t\t} catch (error) {\n\t\t\tthrow new SomethingWentWrong(`Failed to upload file to gs://${bucketName}/${filePath}`, {\n\t\t\t\tcause: error,\n\t\t\t})\n\t\t}\n\t\tconst [metadata] = await file.getMetadata()\n\t\treturn {\n\t\t\turi: file.cloudStorageURI.href,\n\t\t\tfileSize: Number(metadata.size ?? 0),\n\t\t\tchecksumCrc32c: metadata.crc32c,\n\t\t\tchecksumMd5: metadata.md5Hash,\n\t\t\tcontentType: metadata.contentType ?? options?.contentType ?? \"application/octet-stream\",\n\t\t\tbucketName,\n\t\t\tfilePath,\n\t\t}\n\t}\n\n\t/**\n\t * Upload new file to GCS from the given file URL\n\t */\n\tasync uploadFromUrl(\n\t\tbucketName: string,\n\t\tfilePath: string,\n\t\tfileDownloadUrl: string,\n\t\toptions?: UploadOptions,\n\t): Promise<UploadResult> {\n\t\tconst response = await fetch(fileDownloadUrl)\n\t\tif (!response.ok) {\n\t\t\tif (response.status === 404) {\n\t\t\t\tthrow new NotFoundError(`File not found: ${fileDownloadUrl}`)\n\t\t\t}\n\t\t\tif (response.status >= 400 && response.status < 500) {\n\t\t\t\tthrow new BadRequestError(\n\t\t\t\t\t`Failed to fetch file from ${fileDownloadUrl}: Got status code ${response.status} ${response.statusText}`,\n\t\t\t\t)\n\t\t\t}\n\t\t\tthrow new BadRequestError(\n\t\t\t\t`Failed to fetch file from ${fileDownloadUrl}: ${response.status} ${response.statusText}`,\n\t\t\t)\n\t\t}\n\t\tconst file = this.storage.bucket(bucketName).file(filePath)\n\n\t\tconst stream = response.body\n\t\tif (!stream) {\n\t\t\tthrow new SomethingWentWrong(`Failed to get stream from ${fileDownloadUrl}`, {\n\t\t\t\tcause: new Error(`Failed to get stream from ${fileDownloadUrl}`),\n\t\t\t})\n\t\t}\n\t\ttry {\n\t\t\tawait pipeline(\n\t\t\t\tstream,\n\t\t\t\tfile.createWriteStream({\n\t\t\t\t\t...options,\n\t\t\t\t\tresumable: false,\n\t\t\t\t\tcontentType: response.headers.get(\"content-type\") ?? options?.contentType ?? undefined,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t...options?.metadata,\n\t\t\t\t\t\tsrc_url: fileDownloadUrl,\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t)\n\n\t\t\tconst [metadata] = await file.getMetadata()\n\t\t\treturn {\n\t\t\t\turi: file.cloudStorageURI.href,\n\t\t\t\tfileSize: Number(metadata.size ?? 0),\n\t\t\t\tchecksumCrc32c: metadata.crc32c,\n\t\t\t\tchecksumMd5: metadata.md5Hash,\n\t\t\t\tcontentType:\n\t\t\t\t\tmetadata.contentType ??\n\t\t\t\t\tresponse.headers.get(\"content-type\") ??\n\t\t\t\t\toptions?.contentType ??\n\t\t\t\t\t\"application/octet-stream\",\n\t\t\t\tbucketName,\n\t\t\t\tfilePath,\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthrow new SomethingWentWrong(`Failed to upload file to gs://${bucketName}/${filePath}`, {\n\t\t\t\tcause: error,\n\t\t\t})\n\t\t}\n\t}\n\n\tasync getSignedUrl(fileUrl: string, ttl: number = 1000 * 60 * 60 * 1) {\n\t\t// Determine bucket name and the bucket base URL from either subdomain or path-style URL\n\t\tconst info = CloudStorageService.extractInfo(fileUrl)\n\t\tif (!info) {\n\t\t\treturn fileUrl\n\t\t}\n\n\t\ttry {\n\t\t\t// Get file reference from GCS bucket\n\t\t\tconst bucket = this.storage.bucket(info.bucketName)\n\t\t\tconst file = bucket.file(info.filePath)\n\n\t\t\tconst now = new Date()\n\n\t\t\t// Generate signed URL\n\t\t\tconst [signedUrl] = await file.getSignedUrl({\n\t\t\t\taction: \"read\",\n\t\t\t\taccessibleAt: now,\n\t\t\t\texpires: new Date(now.getTime() + ttl),\n\t\t\t})\n\n\t\t\t// Replace the canonical https://storage.googleapis.com/<bucket> with the subdomain public URL\n\t\t\treturn signedUrl.replace(\n\t\t\t\t`https://storage.googleapis.com/${info.bucketName}`,\n\t\t\t\tCloudStorageService.basePublicUrl(info),\n\t\t\t)\n\t\t} catch (error: unknown) {\n\t\t\tif (isGCSError(error)) {\n\t\t\t\tif (error.code === 404 || (error instanceof Error && error.message?.toLowerCase().includes(\"not found\"))) {\n\t\t\t\t\tthrow new NotFoundError(`File not found for signed URL generation: gs://${info.bucketName}/${info.filePath}`)\n\t\t\t\t}\n\t\t\t\tif (error.code === 403) {\n\t\t\t\t\tthrow new ForbiddenError(`Access denied to generate signed URL for: gs://${info.bucketName}/${info.filePath}`)\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new SomethingWentWrong(`Failed to generate signed URL for file: ${fileUrl}`, {\n\t\t\t\tcause: error,\n\t\t\t})\n\t\t}\n\t}\n\n\tasync checkResourceType(resourceUrl: string): Promise<\"file\" | \"folder\" | null> {\n\t\tconst info = CloudStorageService.extractInfo(resourceUrl)\n\t\tif (!info) {\n\t\t\treturn null\n\t\t}\n\t\ttry {\n\t\t\tconst bucket = this.storage.bucket(info.bucketName)\n\t\t\tconst file = bucket.file(info.filePath)\n\t\t\tconst [fileExists] = await file.exists()\n\t\t\tif (fileExists) {\n\t\t\t\treturn \"file\"\n\t\t\t}\n\n\t\t\t// Check if folder by listing files with prefix\n\t\t\tconst [files] = await bucket.getFiles({\n\t\t\t\tprefix: resourceUrl.endsWith(\"/\") ? resourceUrl : resourceUrl + \"/\",\n\t\t\t\tmaxResults: 1,\n\t\t\t})\n\t\t\tif (files.length > 0) {\n\t\t\t\treturn \"folder\"\n\t\t\t}\n\t\t\treturn null\n\t\t} catch (error) {\n\t\t\tif (isGCSError(error)) {\n\t\t\t\tif (error.code === 404 || (error instanceof Error && error.message?.toLowerCase().includes(\"not found\"))) {\n\t\t\t\t\tthrow new NotFoundError(`File not found for signed URL generation: gs://${info.bucketName}/${info.filePath}`)\n\t\t\t\t}\n\t\t\t\tif (error.code === 403) {\n\t\t\t\t\tthrow new ForbiddenError(`Access denied to generate signed URL for: gs://${info.bucketName}/${info.filePath}`)\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new SomethingWentWrong(`Failed to check item type: ${resourceUrl}`, {\n\t\t\t\tcause: error,\n\t\t\t})\n\t\t}\n\t}\n\n\t/**\n\t * Check if a URL is a GCS URL\n\t * @param fileUrl - The URL of the file.\n\t * @returns True if the URL is a GCS URL, false otherwise.\n\t */\n\tstatic isGCSUrl(fileUrl: string): boolean {\n\t\tif (fileUrl.startsWith(\"gs://\")) {\n\t\t\treturn true\n\t\t}\n\t\tconst url = new URL(fileUrl)\n\t\treturn url.hostname.endsWith(\".storage.googleapis.com\") || url.hostname === \"storage.googleapis.com\"\n\t}\n\n\t/**\n\t * Extract GCS File info from a URL\n\t * @param baseMediaUrl - The URL of the file.\n\t * e.g.\n\t *   - `gs://{bucketName}/{objectPath}`\n\t *   - `https://{bucketName}.storage.googleapis.com/{objectPath}`\n\t *   - `https://storage.googleapis.com/{bucketName}/{objectPath}`\n\t */\n\tstatic extractInfo(baseMediaUrl: string): FileUriInfo | null {\n\t\tconst url = new URL(baseMediaUrl)\n\t\tlet bucketName: string | null = null\n\t\tlet objectPath = \"\"\n\n\t\t// Handle gs:// format\n\t\tif (baseMediaUrl.startsWith(\"gs://\")) {\n\t\t\tconst [, path] = baseMediaUrl.split(\"gs://\")\n\t\t\tif (!path) {\n\t\t\t\treturn null\n\t\t\t}\n\t\t\tconst [bucket, ...objectParts] = path.split(\"/\")\n\t\t\tif (!bucket) {\n\t\t\t\treturn null\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tbucketName: bucket,\n\t\t\t\tfilePath: objectParts.join(\"/\"),\n\t\t\t}\n\t\t}\n\n\t\t// Handle public URL format\n\t\tif (url.hostname.endsWith(\".storage.googleapis.com\")) {\n\t\t\t// Subdomain style: https://<bucket>.storage.googleapis.com/<object>\n\t\t\tbucketName = url.hostname.replace(\".storage.googleapis.com\", \"\")\n\t\t\tobjectPath = url.pathname.replace(/^\\/+/, \"\")\n\t\t} else if (url.hostname === \"storage.googleapis.com\") {\n\t\t\t// Path style: https://storage.googleapis.com/<bucket>/<object>\n\t\t\tconst segments = url.pathname.split(\"/\").filter(Boolean)\n\t\t\tif (!segments[0]) {\n\t\t\t\treturn null\n\t\t\t}\n\t\t\tbucketName = segments[0]\n\t\t\tobjectPath = segments.slice(1).join(\"/\")\n\t\t} else {\n\t\t\treturn null\n\t\t}\n\t\tlet decodedObjectPath = objectPath\n\t\ttry {\n\t\t\tdecodedObjectPath = decodeURIComponent(objectPath)\n\t\t} catch {\n\t\t\tdecodedObjectPath = objectPath\n\t\t}\n\t\treturn {\n\t\t\tbucketName: bucketName,\n\t\t\tfilePath: decodedObjectPath,\n\t\t}\n\t}\n\n\tstatic basePublicUrl(fileInfo: FileUriInfo): string {\n\t\treturn `https://${fileInfo.bucketName}.storage.googleapis.com`\n\t}\n\n\tstatic toPublicUrl(fileInfo: FileUriInfo): string {\n\t\treturn `https://${fileInfo.bucketName}.storage.googleapis.com/${fileInfo.filePath}`\n\t}\n\n\tstatic toGCSUri(fileInfo: FileUriInfo): string {\n\t\treturn `gs://${fileInfo.bucketName}/${fileInfo.filePath}`\n\t}\n}\n"],"mappings":"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","names":[]}