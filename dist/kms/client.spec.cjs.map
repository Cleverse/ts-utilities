{"version":3,"sources":["/home/runner/work/ts-utilities/ts-utilities/dist/kms/client.spec.cjs","../../src/kms/client.spec.ts"],"names":[],"mappings":"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","file":"/home/runner/work/ts-utilities/ts-utilities/dist/kms/client.spec.cjs","sourcesContent":[null,"import crypto from \"node:crypto\"\n\nimport { describe, expect, it, vi, beforeEach } from \"vitest\"\n\nimport { KMSClient } from \"./client\"\n\n// Mock the KeyManagementServiceClient\nconst {\n\tmockEncrypt,\n\tmockDecrypt,\n\tmockAsymmetricDecrypt,\n\tmockGetPublicKey,\n\tmockCryptoKeyPath,\n\tmockCryptoKeyVersionPath,\n\tmockClose,\n} = vi.hoisted(() => ({\n\tmockEncrypt: vi.fn(),\n\tmockDecrypt: vi.fn(),\n\tmockAsymmetricDecrypt: vi.fn(),\n\tmockGetPublicKey: vi.fn(),\n\tmockCryptoKeyPath: vi.fn(),\n\tmockCryptoKeyVersionPath: vi.fn(),\n\tmockClose: vi.fn(),\n}))\n\nvi.mock(\"@google-cloud/kms\", () => {\n\treturn {\n\t\tKeyManagementServiceClient: class {\n\t\t\tencrypt = mockEncrypt\n\t\t\tdecrypt = mockDecrypt\n\t\t\tasymmetricDecrypt = mockAsymmetricDecrypt\n\t\t\tgetPublicKey = mockGetPublicKey\n\t\t\tcryptoKeyPath = mockCryptoKeyPath\n\t\t\tcryptoKeyVersionPath = mockCryptoKeyVersionPath\n\t\t\tclose = mockClose\n\t\t},\n\t}\n})\n\ndescribe(\"KMSClient\", () => {\n\tconst config = {\n\t\tproject: \"test-project\",\n\t\tlocation: \"global\",\n\t\tkeyRing: \"test-key-ring\",\n\t\tkey: \"test-key\",\n\t}\n\n\tlet kmsClient: KMSClient\n\tlet asymmetricKmsClient: KMSClient\n\n\tbeforeEach(() => {\n\t\tvi.clearAllMocks()\n\t\tmockCryptoKeyPath.mockReturnValue(\n\t\t\t\"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key\",\n\t\t)\n\t\tmockCryptoKeyVersionPath.mockImplementation(\n\t\t\t(p, l, r, k, v) => `projects/${p}/locations/${l}/keyRings/${r}/cryptoKeys/${k}/cryptoKeyVersions/${v}`,\n\t\t)\n\t\tkmsClient = new KMSClient({ ...config, keyBased: \"symmetric\" })\n\t\tasymmetricKmsClient = new KMSClient({ ...config, keyBased: \"asymmetric\" })\n\t})\n\n\tdescribe(\"encrypt\", () => {\n\t\tit(\"should encrypt plaintext correctly (symmetric) and return ciphertext and key version\", async () => {\n\t\t\tconst plaintext = \"hello world\"\n\t\t\tconst mockCiphertext = Buffer.from(\"encrypted-data\")\n\t\t\tconst mockResponse = {\n\t\t\t\tciphertext: mockCiphertext,\n\t\t\t\tname: \"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/1\",\n\t\t\t}\n\n\t\t\tmockEncrypt.mockResolvedValue([mockResponse])\n\n\t\t\tconst result = await kmsClient.encrypt(plaintext)\n\n\t\t\texpect(mockEncrypt).toHaveBeenCalledWith({\n\t\t\t\tname: \"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key\",\n\t\t\t\tplaintext: Buffer.from(plaintext),\n\t\t\t})\n\t\t\texpect(result.ciphertext).toBe(mockCiphertext.toString(\"base64\"))\n\t\t\texpect(result.cryptoKeyVersion).toBe(\"1\")\n\t\t})\n\n\t\tit(\"should encrypt with specific key version (asymmetric) if provided\", async () => {\n\t\t\tconst plaintext = \"hello world\"\n\t\t\tconst version = \"2\"\n\t\t\t// Generate a real key pair for testing\n\t\t\tconst { publicKey } = crypto.generateKeyPairSync(\"rsa\", {\n\t\t\t\tmodulusLength: 2048,\n\t\t\t})\n\t\t\tconst publicKeyPem = publicKey.export({ type: \"spki\", format: \"pem\" })\n\n\t\t\tconst mockPublicKeyResponse = {\n\t\t\t\tpem: publicKeyPem,\n\t\t\t\talgorithm: \"RSA_DECRYPT_OAEP_2048_SHA256\",\n\t\t\t}\n\n\t\t\tmockGetPublicKey.mockResolvedValue([mockPublicKeyResponse])\n\n\t\t\tconst result = await asymmetricKmsClient.encrypt(plaintext, version)\n\n\t\t\texpect(mockGetPublicKey).toHaveBeenCalledWith({\n\t\t\t\tname: `projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/${version}`,\n\t\t\t})\n\n\t\t\t// Verify result format\n\t\t\texpect(result.cryptoKeyVersion).toBe(version)\n\t\t\texpect(typeof result.ciphertext).toBe(\"string\")\n\t\t})\n\t})\n\n\tdescribe(\"encryptAsymmetric\", () => {\n\t\tit(\"should encrypt plaintext using public key from KMS\", async () => {\n\t\t\tconst plaintext = \"hello world\"\n\t\t\tconst version = \"3\"\n\t\t\tconst { publicKey } = crypto.generateKeyPairSync(\"rsa\", {\n\t\t\t\tmodulusLength: 2048,\n\t\t\t})\n\t\t\tconst publicKeyPem = publicKey.export({ type: \"spki\", format: \"pem\" })\n\n\t\t\tconst mockPublicKeyResponse = {\n\t\t\t\tpem: publicKeyPem,\n\t\t\t\talgorithm: \"RSA_DECRYPT_OAEP_2048_SHA256\",\n\t\t\t}\n\n\t\t\tmockGetPublicKey.mockResolvedValue([mockPublicKeyResponse])\n\n\t\t\tconst result = await asymmetricKmsClient.encryptAsymmetric(plaintext, version)\n\n\t\t\texpect(mockGetPublicKey).toHaveBeenCalledWith({\n\t\t\t\tname: `projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/${version}`,\n\t\t\t})\n\t\t\texpect(result.cryptoKeyVersion).toBe(version)\n\t\t\texpect(typeof result.ciphertext).toBe(\"string\")\n\t\t})\n\n\t\tit(\"should use SHA512 hash if algorithm specifies it\", async () => {\n\t\t\tconst plaintext = \"hello world\"\n\t\t\tconst version = \"3\"\n\t\t\tconst { publicKey } = crypto.generateKeyPairSync(\"rsa\", {\n\t\t\t\tmodulusLength: 4096,\n\t\t\t})\n\t\t\tconst publicKeyPem = publicKey.export({ type: \"spki\", format: \"pem\" })\n\n\t\t\tconst mockPublicKeyResponse = {\n\t\t\t\tpem: publicKeyPem,\n\t\t\t\talgorithm: \"RSA_DECRYPT_OAEP_4096_SHA512\",\n\t\t\t}\n\n\t\t\tmockGetPublicKey.mockResolvedValue([mockPublicKeyResponse])\n\n\t\t\t// Spy on crypto.publicEncrypt to verify options\n\t\t\tconst publicEncryptSpy = vi.spyOn(crypto, \"publicEncrypt\")\n\n\t\t\tawait asymmetricKmsClient.encryptAsymmetric(plaintext, version)\n\n\t\t\texpect(publicEncryptSpy).toHaveBeenCalledWith(\n\t\t\t\texpect.objectContaining({\n\t\t\t\t\toaepHash: \"sha512\",\n\t\t\t\t}),\n\t\t\t\texpect.anything(),\n\t\t\t)\n\t\t})\n\n\t\tit(\"should throw error if public key PEM is missing\", async () => {\n\t\t\tmockGetPublicKey.mockResolvedValue([{}]) // Empty response\n\n\t\t\tawait expect(asymmetricKmsClient.encryptAsymmetric(\"data\", \"1\")).rejects.toThrow(\n\t\t\t\t\"Failed to encrypt asymmetrically with KMS\",\n\t\t\t)\n\t\t})\n\t})\n\n\tdescribe(\"decrypt\", () => {\n\t\tit(\"should decrypt ciphertext correctly\", async () => {\n\t\t\tconst ciphertext = Buffer.from(\"encrypted-data\").toString(\"base64\")\n\t\t\tconst mockPlaintext = Buffer.from(\"hello world\")\n\t\t\tconst mockResponse = {\n\t\t\t\tplaintext: mockPlaintext,\n\t\t\t}\n\n\t\t\tmockDecrypt.mockResolvedValue([mockResponse])\n\n\t\t\tconst result = await kmsClient.decrypt(ciphertext)\n\n\t\t\texpect(mockDecrypt).toHaveBeenCalledWith({\n\t\t\t\tname: \"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key\",\n\t\t\t\tciphertext: Buffer.from(ciphertext, \"base64\"),\n\t\t\t})\n\t\t\texpect(result).toBe(\"hello world\")\n\t\t})\n\t})\n\n\tdescribe(\"decryptAsymmetric\", () => {\n\t\tit(\"should decrypt asymmetric ciphertext correctly\", async () => {\n\t\t\tconst ciphertext = Buffer.from(\"encrypted-data-asym\").toString(\"base64\")\n\t\t\tconst mockPlaintext = Buffer.from(\"hello world asymmetric\")\n\t\t\tconst version = \"1\"\n\t\t\tconst mockResponse = {\n\t\t\t\tplaintext: mockPlaintext,\n\t\t\t}\n\n\t\t\tmockAsymmetricDecrypt.mockResolvedValue([mockResponse])\n\n\t\t\tconst result = await asymmetricKmsClient.decryptAsymmetric(ciphertext, version)\n\n\t\t\texpect(mockAsymmetricDecrypt).toHaveBeenCalledWith({\n\t\t\t\tname: `projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/${version}`,\n\t\t\t\tciphertext: Buffer.from(ciphertext, \"base64\"),\n\t\t\t})\n\t\t\texpect(result).toBe(\"hello world asymmetric\")\n\t\t})\n\t})\n})\n"]}