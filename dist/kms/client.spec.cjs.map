{"version":3,"sources":["/home/runner/work/ts-utilities/ts-utilities/dist/kms/client.spec.cjs","../../src/kms/client.spec.ts"],"names":[],"mappings":"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","file":"/home/runner/work/ts-utilities/ts-utilities/dist/kms/client.spec.cjs","sourcesContent":[null,"import { describe, expect, it, vi, beforeEach } from \"vitest\"\n\nimport { KMSClient } from \"./client\"\n\n// Mock the KeyManagementServiceClient\nconst { mockEncrypt, mockDecrypt, mockAsymmetricDecrypt, mockCryptoKeyPath, mockCryptoKeyVersionPath, mockClose } =\n\tvi.hoisted(() => ({\n\t\tmockEncrypt: vi.fn(),\n\t\tmockDecrypt: vi.fn(),\n\t\tmockAsymmetricDecrypt: vi.fn(),\n\t\tmockCryptoKeyPath: vi.fn(),\n\t\tmockCryptoKeyVersionPath: vi.fn(),\n\t\tmockClose: vi.fn(),\n\t}))\n\nvi.mock(\"@google-cloud/kms\", () => {\n\treturn {\n\t\tKeyManagementServiceClient: class {\n\t\t\tencrypt = mockEncrypt\n\t\t\tdecrypt = mockDecrypt\n\t\t\tasymmetricDecrypt = mockAsymmetricDecrypt\n\t\t\tcryptoKeyPath = mockCryptoKeyPath\n\t\t\tcryptoKeyVersionPath = mockCryptoKeyVersionPath\n\t\t\tclose = mockClose\n\t\t},\n\t}\n})\n\ndescribe(\"KMSClient\", () => {\n\tconst config = {\n\t\tproject: \"test-project\",\n\t\tlocation: \"global\",\n\t\tkeyRing: \"test-key-ring\",\n\t\tkey: \"test-key\",\n\t}\n\n\tlet kmsClient: KMSClient\n\n\tbeforeEach(() => {\n\t\tvi.clearAllMocks()\n\t\tmockCryptoKeyPath.mockReturnValue(\n\t\t\t\"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key\",\n\t\t)\n\t\tmockCryptoKeyVersionPath.mockImplementation(\n\t\t\t(p, l, r, k, v) => `projects/${p}/locations/${l}/keyRings/${r}/cryptoKeys/${k}/cryptoKeyVersions/${v}`,\n\t\t)\n\t\tkmsClient = new KMSClient(config)\n\t})\n\n\tdescribe(\"encrypt\", () => {\n\t\tit(\"should encrypt plaintext correctly and return ciphertext and key version\", async () => {\n\t\t\tconst plaintext = \"hello world\"\n\t\t\tconst mockCiphertext = Buffer.from(\"encrypted-data\")\n\t\t\tconst mockResponse = {\n\t\t\t\tciphertext: mockCiphertext,\n\t\t\t\tname: \"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/1\",\n\t\t\t}\n\n\t\t\tmockEncrypt.mockResolvedValue([mockResponse])\n\n\t\t\tconst result = await kmsClient.encrypt(plaintext)\n\n\t\t\texpect(mockEncrypt).toHaveBeenCalledWith({\n\t\t\t\tname: \"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key\",\n\t\t\t\tplaintext: Buffer.from(plaintext),\n\t\t\t})\n\t\t\texpect(result.ciphertext).toBe(mockCiphertext.toString(\"base64\"))\n\t\t\texpect(result.cryptoKeyVersion).toBe(\"1\")\n\t\t})\n\n\t\tit(\"should encrypt with specific key version if provided\", async () => {\n\t\t\tconst plaintext = \"hello world\"\n\t\t\tconst version = \"2\"\n\t\t\tconst mockCiphertext = Buffer.from(\"encrypted-data-v2\")\n\t\t\tconst mockResponse = {\n\t\t\t\tciphertext: mockCiphertext,\n\t\t\t\tname: `projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/${version}`,\n\t\t\t}\n\n\t\t\tmockEncrypt.mockResolvedValue([mockResponse])\n\n\t\t\tconst result = await kmsClient.encrypt(plaintext, version)\n\n\t\t\texpect(mockEncrypt).toHaveBeenCalledWith({\n\t\t\t\tname: `projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/${version}`,\n\t\t\t\tplaintext: Buffer.from(plaintext),\n\t\t\t})\n\t\t\texpect(result.ciphertext).toBe(mockCiphertext.toString(\"base64\"))\n\t\t\texpect(result.cryptoKeyVersion).toBe(version)\n\t\t})\n\t})\n\n\tdescribe(\"decrypt\", () => {\n\t\tit(\"should decrypt ciphertext correctly\", async () => {\n\t\t\tconst ciphertext = Buffer.from(\"encrypted-data\").toString(\"base64\")\n\t\t\tconst mockPlaintext = Buffer.from(\"hello world\")\n\t\t\tconst mockResponse = {\n\t\t\t\tplaintext: mockPlaintext,\n\t\t\t}\n\n\t\t\tmockDecrypt.mockResolvedValue([mockResponse])\n\n\t\t\tconst result = await kmsClient.decrypt(ciphertext)\n\n\t\t\texpect(mockDecrypt).toHaveBeenCalledWith({\n\t\t\t\tname: \"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key\",\n\t\t\t\tciphertext: Buffer.from(ciphertext, \"base64\"),\n\t\t\t})\n\t\t\texpect(result).toBe(\"hello world\")\n\t\t})\n\t})\n\n\tdescribe(\"decryptAsymmetric\", () => {\n\t\tit(\"should decrypt asymmetric ciphertext correctly\", async () => {\n\t\t\tconst ciphertext = Buffer.from(\"encrypted-data-asym\").toString(\"base64\")\n\t\t\tconst mockPlaintext = Buffer.from(\"hello world asymmetric\")\n\t\t\tconst version = \"1\"\n\t\t\tconst mockResponse = {\n\t\t\t\tplaintext: mockPlaintext,\n\t\t\t}\n\n\t\t\tmockAsymmetricDecrypt.mockResolvedValue([mockResponse])\n\n\t\t\tconst result = await kmsClient.decryptAsymmetric(ciphertext, version)\n\n\t\t\texpect(mockAsymmetricDecrypt).toHaveBeenCalledWith({\n\t\t\t\tname: `projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/${version}`,\n\t\t\t\tciphertext: Buffer.from(ciphertext, \"base64\"),\n\t\t\t})\n\t\t\texpect(result).toBe(\"hello world asymmetric\")\n\t\t})\n\t})\n})\n"]}