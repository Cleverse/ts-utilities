{"version":3,"sources":["../../src/kms/client.spec.ts"],"sourcesContent":["import crypto from \"node:crypto\"\n\nimport { describe, expect, it, vi, beforeEach } from \"vitest\"\n\nimport { KMSClient } from \"./client\"\n\n// Mock the KeyManagementServiceClient\nconst {\n\tmockEncrypt,\n\tmockDecrypt,\n\tmockAsymmetricDecrypt,\n\tmockGetPublicKey,\n\tmockCryptoKeyPath,\n\tmockCryptoKeyVersionPath,\n\tmockClose,\n} = vi.hoisted(() => ({\n\tmockEncrypt: vi.fn(),\n\tmockDecrypt: vi.fn(),\n\tmockAsymmetricDecrypt: vi.fn(),\n\tmockGetPublicKey: vi.fn(),\n\tmockCryptoKeyPath: vi.fn(),\n\tmockCryptoKeyVersionPath: vi.fn(),\n\tmockClose: vi.fn(),\n}))\n\nvi.mock(\"@google-cloud/kms\", () => {\n\treturn {\n\t\tKeyManagementServiceClient: class {\n\t\t\tencrypt = mockEncrypt\n\t\t\tdecrypt = mockDecrypt\n\t\t\tasymmetricDecrypt = mockAsymmetricDecrypt\n\t\t\tgetPublicKey = mockGetPublicKey\n\t\t\tcryptoKeyPath = mockCryptoKeyPath\n\t\t\tcryptoKeyVersionPath = mockCryptoKeyVersionPath\n\t\t\tclose = mockClose\n\t\t},\n\t}\n})\n\ndescribe(\"KMSClient\", () => {\n\tconst config = {\n\t\tproject: \"test-project\",\n\t\tlocation: \"global\",\n\t\tkeyRing: \"test-key-ring\",\n\t\tkey: \"test-key\",\n\t}\n\n\tlet kmsClient: KMSClient\n\tlet asymmetricKmsClient: KMSClient\n\n\tbeforeEach(() => {\n\t\tvi.clearAllMocks()\n\t\tmockCryptoKeyPath.mockReturnValue(\n\t\t\t\"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key\",\n\t\t)\n\t\tmockCryptoKeyVersionPath.mockImplementation(\n\t\t\t(p, l, r, k, v) => `projects/${p}/locations/${l}/keyRings/${r}/cryptoKeys/${k}/cryptoKeyVersions/${v}`,\n\t\t)\n\t\tkmsClient = new KMSClient({ ...config, keyBased: \"symmetric\" })\n\t\tasymmetricKmsClient = new KMSClient({ ...config, keyBased: \"asymmetric\" })\n\t})\n\n\tdescribe(\"encrypt\", () => {\n\t\tit(\"should encrypt plaintext correctly (symmetric) and return ciphertext and key version\", async () => {\n\t\t\tconst plaintext = \"hello world\"\n\t\t\tconst mockCiphertext = Buffer.from(\"encrypted-data\")\n\t\t\tconst mockResponse = {\n\t\t\t\tciphertext: mockCiphertext,\n\t\t\t\tname: \"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/1\",\n\t\t\t}\n\n\t\t\tmockEncrypt.mockResolvedValue([mockResponse])\n\n\t\t\tconst result = await kmsClient.encrypt(plaintext)\n\n\t\t\texpect(mockEncrypt).toHaveBeenCalledWith({\n\t\t\t\tname: \"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key\",\n\t\t\t\tplaintext: Buffer.from(plaintext),\n\t\t\t})\n\t\t\texpect(result.ciphertext).toBe(mockCiphertext.toString(\"base64\"))\n\t\t\texpect(result.cryptoKeyVersion).toBe(\"1\")\n\t\t})\n\n\t\tit(\"should encrypt with specific key version (asymmetric) if provided\", async () => {\n\t\t\tconst plaintext = \"hello world\"\n\t\t\tconst version = \"2\"\n\t\t\t// Generate a real key pair for testing\n\t\t\tconst { publicKey } = crypto.generateKeyPairSync(\"rsa\", {\n\t\t\t\tmodulusLength: 2048,\n\t\t\t})\n\t\t\tconst publicKeyPem = publicKey.export({ type: \"spki\", format: \"pem\" })\n\n\t\t\tconst mockPublicKeyResponse = {\n\t\t\t\tpem: publicKeyPem,\n\t\t\t\talgorithm: \"RSA_DECRYPT_OAEP_2048_SHA256\",\n\t\t\t}\n\n\t\t\tmockGetPublicKey.mockResolvedValue([mockPublicKeyResponse])\n\n\t\t\tconst result = await asymmetricKmsClient.encrypt(plaintext, version)\n\n\t\t\texpect(mockGetPublicKey).toHaveBeenCalledWith({\n\t\t\t\tname: `projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/${version}`,\n\t\t\t})\n\n\t\t\t// Verify result format\n\t\t\texpect(result.cryptoKeyVersion).toBe(version)\n\t\t\texpect(typeof result.ciphertext).toBe(\"string\")\n\t\t})\n\t})\n\n\tdescribe(\"encryptAsymmetric\", () => {\n\t\tit(\"should encrypt plaintext using public key from KMS\", async () => {\n\t\t\tconst plaintext = \"hello world\"\n\t\t\tconst version = \"3\"\n\t\t\tconst { publicKey } = crypto.generateKeyPairSync(\"rsa\", {\n\t\t\t\tmodulusLength: 2048,\n\t\t\t})\n\t\t\tconst publicKeyPem = publicKey.export({ type: \"spki\", format: \"pem\" })\n\n\t\t\tconst mockPublicKeyResponse = {\n\t\t\t\tpem: publicKeyPem,\n\t\t\t\talgorithm: \"RSA_DECRYPT_OAEP_2048_SHA256\",\n\t\t\t}\n\n\t\t\tmockGetPublicKey.mockResolvedValue([mockPublicKeyResponse])\n\n\t\t\tconst result = await asymmetricKmsClient.encryptAsymmetric(plaintext, version)\n\n\t\t\texpect(mockGetPublicKey).toHaveBeenCalledWith({\n\t\t\t\tname: `projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/${version}`,\n\t\t\t})\n\t\t\texpect(result.cryptoKeyVersion).toBe(version)\n\t\t\texpect(typeof result.ciphertext).toBe(\"string\")\n\t\t})\n\n\t\tit(\"should use SHA512 hash if algorithm specifies it\", async () => {\n\t\t\tconst plaintext = \"hello world\"\n\t\t\tconst version = \"3\"\n\t\t\tconst { publicKey } = crypto.generateKeyPairSync(\"rsa\", {\n\t\t\t\tmodulusLength: 4096,\n\t\t\t})\n\t\t\tconst publicKeyPem = publicKey.export({ type: \"spki\", format: \"pem\" })\n\n\t\t\tconst mockPublicKeyResponse = {\n\t\t\t\tpem: publicKeyPem,\n\t\t\t\talgorithm: \"RSA_DECRYPT_OAEP_4096_SHA512\",\n\t\t\t}\n\n\t\t\tmockGetPublicKey.mockResolvedValue([mockPublicKeyResponse])\n\n\t\t\t// Spy on crypto.publicEncrypt to verify options\n\t\t\tconst publicEncryptSpy = vi.spyOn(crypto, \"publicEncrypt\")\n\n\t\t\tawait asymmetricKmsClient.encryptAsymmetric(plaintext, version)\n\n\t\t\texpect(publicEncryptSpy).toHaveBeenCalledWith(\n\t\t\t\texpect.objectContaining({\n\t\t\t\t\toaepHash: \"sha512\",\n\t\t\t\t}),\n\t\t\t\texpect.anything(),\n\t\t\t)\n\t\t})\n\n\t\tit(\"should throw error if public key PEM is missing\", async () => {\n\t\t\tmockGetPublicKey.mockResolvedValue([{}]) // Empty response\n\n\t\t\tawait expect(asymmetricKmsClient.encryptAsymmetric(\"data\", \"1\")).rejects.toThrow(\n\t\t\t\t\"Failed to encrypt asymmetrically with KMS\",\n\t\t\t)\n\t\t})\n\t})\n\n\tdescribe(\"decrypt\", () => {\n\t\tit(\"should decrypt ciphertext correctly\", async () => {\n\t\t\tconst ciphertext = Buffer.from(\"encrypted-data\").toString(\"base64\")\n\t\t\tconst mockPlaintext = Buffer.from(\"hello world\")\n\t\t\tconst mockResponse = {\n\t\t\t\tplaintext: mockPlaintext,\n\t\t\t}\n\n\t\t\tmockDecrypt.mockResolvedValue([mockResponse])\n\n\t\t\tconst result = await kmsClient.decrypt(ciphertext)\n\n\t\t\texpect(mockDecrypt).toHaveBeenCalledWith({\n\t\t\t\tname: \"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key\",\n\t\t\t\tciphertext: Buffer.from(ciphertext, \"base64\"),\n\t\t\t})\n\t\t\texpect(result).toBe(\"hello world\")\n\t\t})\n\t})\n\n\tdescribe(\"decryptAsymmetric\", () => {\n\t\tit(\"should decrypt asymmetric ciphertext correctly\", async () => {\n\t\t\tconst ciphertext = Buffer.from(\"encrypted-data-asym\").toString(\"base64\")\n\t\t\tconst mockPlaintext = Buffer.from(\"hello world asymmetric\")\n\t\t\tconst version = \"1\"\n\t\t\tconst mockResponse = {\n\t\t\t\tplaintext: mockPlaintext,\n\t\t\t}\n\n\t\t\tmockAsymmetricDecrypt.mockResolvedValue([mockResponse])\n\n\t\t\tconst result = await asymmetricKmsClient.decryptAsymmetric(ciphertext, version)\n\n\t\t\texpect(mockAsymmetricDecrypt).toHaveBeenCalledWith({\n\t\t\t\tname: `projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/${version}`,\n\t\t\t\tciphertext: Buffer.from(ciphertext, \"base64\"),\n\t\t\t})\n\t\t\texpect(result).toBe(\"hello world asymmetric\")\n\t\t})\n\t})\n})\n"],"mappings":"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","names":[]}