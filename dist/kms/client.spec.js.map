{"version":3,"sources":["../../src/kms/client.spec.ts"],"sourcesContent":["import { describe, expect, it, vi, beforeEach } from \"vitest\"\n\nimport { KMSClient } from \"./client\"\n\n// Mock the KeyManagementServiceClient\nconst { mockEncrypt, mockDecrypt, mockAsymmetricDecrypt, mockCryptoKeyPath, mockCryptoKeyVersionPath, mockClose } =\n\tvi.hoisted(() => ({\n\t\tmockEncrypt: vi.fn(),\n\t\tmockDecrypt: vi.fn(),\n\t\tmockAsymmetricDecrypt: vi.fn(),\n\t\tmockCryptoKeyPath: vi.fn(),\n\t\tmockCryptoKeyVersionPath: vi.fn(),\n\t\tmockClose: vi.fn(),\n\t}))\n\nvi.mock(\"@google-cloud/kms\", () => {\n\treturn {\n\t\tKeyManagementServiceClient: class {\n\t\t\tencrypt = mockEncrypt\n\t\t\tdecrypt = mockDecrypt\n\t\t\tasymmetricDecrypt = mockAsymmetricDecrypt\n\t\t\tcryptoKeyPath = mockCryptoKeyPath\n\t\t\tcryptoKeyVersionPath = mockCryptoKeyVersionPath\n\t\t\tclose = mockClose\n\t\t},\n\t}\n})\n\ndescribe(\"KMSClient\", () => {\n\tconst config = {\n\t\tproject: \"test-project\",\n\t\tlocation: \"global\",\n\t\tkeyRing: \"test-key-ring\",\n\t\tkey: \"test-key\",\n\t}\n\n\tlet kmsClient: KMSClient\n\n\tbeforeEach(() => {\n\t\tvi.clearAllMocks()\n\t\tmockCryptoKeyPath.mockReturnValue(\n\t\t\t\"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key\",\n\t\t)\n\t\tmockCryptoKeyVersionPath.mockImplementation(\n\t\t\t(p, l, r, k, v) => `projects/${p}/locations/${l}/keyRings/${r}/cryptoKeys/${k}/cryptoKeyVersions/${v}`,\n\t\t)\n\t\tkmsClient = new KMSClient(config)\n\t})\n\n\tdescribe(\"encrypt\", () => {\n\t\tit(\"should encrypt plaintext correctly and return ciphertext and key version\", async () => {\n\t\t\tconst plaintext = \"hello world\"\n\t\t\tconst mockCiphertext = Buffer.from(\"encrypted-data\")\n\t\t\tconst mockResponse = {\n\t\t\t\tciphertext: mockCiphertext,\n\t\t\t\tname: \"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/1\",\n\t\t\t}\n\n\t\t\tmockEncrypt.mockResolvedValue([mockResponse])\n\n\t\t\tconst result = await kmsClient.encrypt(plaintext)\n\n\t\t\texpect(mockEncrypt).toHaveBeenCalledWith({\n\t\t\t\tname: \"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key\",\n\t\t\t\tplaintext: Buffer.from(plaintext),\n\t\t\t})\n\t\t\texpect(result.ciphertext).toBe(mockCiphertext.toString(\"base64\"))\n\t\t\texpect(result.cryptoKeyVersion).toBe(\"1\")\n\t\t})\n\n\t\tit(\"should encrypt with specific key version if provided\", async () => {\n\t\t\tconst plaintext = \"hello world\"\n\t\t\tconst version = \"2\"\n\t\t\tconst mockCiphertext = Buffer.from(\"encrypted-data-v2\")\n\t\t\tconst mockResponse = {\n\t\t\t\tciphertext: mockCiphertext,\n\t\t\t\tname: `projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/${version}`,\n\t\t\t}\n\n\t\t\tmockEncrypt.mockResolvedValue([mockResponse])\n\n\t\t\tconst result = await kmsClient.encrypt(plaintext, version)\n\n\t\t\texpect(mockEncrypt).toHaveBeenCalledWith({\n\t\t\t\tname: `projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/${version}`,\n\t\t\t\tplaintext: Buffer.from(plaintext),\n\t\t\t})\n\t\t\texpect(result.ciphertext).toBe(mockCiphertext.toString(\"base64\"))\n\t\t\texpect(result.cryptoKeyVersion).toBe(version)\n\t\t})\n\t})\n\n\tdescribe(\"decrypt\", () => {\n\t\tit(\"should decrypt ciphertext correctly\", async () => {\n\t\t\tconst ciphertext = Buffer.from(\"encrypted-data\").toString(\"base64\")\n\t\t\tconst mockPlaintext = Buffer.from(\"hello world\")\n\t\t\tconst mockResponse = {\n\t\t\t\tplaintext: mockPlaintext,\n\t\t\t}\n\n\t\t\tmockDecrypt.mockResolvedValue([mockResponse])\n\n\t\t\tconst result = await kmsClient.decrypt(ciphertext)\n\n\t\t\texpect(mockDecrypt).toHaveBeenCalledWith({\n\t\t\t\tname: \"projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key\",\n\t\t\t\tciphertext: Buffer.from(ciphertext, \"base64\"),\n\t\t\t})\n\t\t\texpect(result).toBe(\"hello world\")\n\t\t})\n\t})\n\n\tdescribe(\"decryptAsymmetric\", () => {\n\t\tit(\"should decrypt asymmetric ciphertext correctly\", async () => {\n\t\t\tconst ciphertext = Buffer.from(\"encrypted-data-asym\").toString(\"base64\")\n\t\t\tconst mockPlaintext = Buffer.from(\"hello world asymmetric\")\n\t\t\tconst version = \"1\"\n\t\t\tconst mockResponse = {\n\t\t\t\tplaintext: mockPlaintext,\n\t\t\t}\n\n\t\t\tmockAsymmetricDecrypt.mockResolvedValue([mockResponse])\n\n\t\t\tconst result = await kmsClient.decryptAsymmetric(ciphertext, version)\n\n\t\t\texpect(mockAsymmetricDecrypt).toHaveBeenCalledWith({\n\t\t\t\tname: `projects/test-project/locations/global/keyRings/test-key-ring/cryptoKeys/test-key/cryptoKeyVersions/${version}`,\n\t\t\t\tciphertext: Buffer.from(ciphertext, \"base64\"),\n\t\t\t})\n\t\t\texpect(result).toBe(\"hello world asymmetric\")\n\t\t})\n\t})\n})\n"],"mappings":"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","names":[]}