{"version":3,"sources":["/home/runner/work/ts-utilities/ts-utilities/dist/chunk-C4CXLHXF.cjs","../src/utils/miscellaneous/retry.ts"],"names":[],"mappings":"AAAA;AACE;AACF,wDAA6B;AAC7B;AACA;ACJA,8CAAA,CAAA;AAEA,8BAA4C;AAIrC,IAAM,WAAA,EAAN,MAAA,QAAyB,MAAM;AAAA,EACrC;AAAA,EAEA,WAAA,CAAY,OAAA,EAAyB;AACpC,IAAA,KAAA,CAAM,CAAA;AAEN,IAAA,GAAA,CAAI,QAAA,WAAmB,KAAA,EAAO;AAC7B,MAAA,IAAA,CAAK,cAAA,EAAgB,OAAA;AACpB,MAAA,CAAC,EAAE,QAAQ,EAAA,EAAI,OAAA,CAAA;AAAA,IACjB,EAAA,KAAO;AACN,MAAA,IAAA,CAAK,cAAA,EAAgB,IAAI,KAAA,CAAM,OAAO,CAAA;AACtC,MAAA,IAAA,CAAK,aAAA,CAAc,MAAA,EAAQ,IAAA,CAAK,KAAA;AAAA,IACjC;AAEA,IAAA,IAAA,CAAK,KAAA,EAAO,YAAA;AACZ,IAAA,IAAA,CAAK,QAAA,EAAU,OAAA;AAAA,EAChB;AACD,CAAA;AAYA,IAAM,wBAAA,EAA0B,CAAC,KAAA,EAAmB,aAAA,EAAuB,OAAA,EAAA,GAAsC;AAEhH,EAAA,MAAM,YAAA,EAAA,kBAAe,OAAA,CAAQ,OAAA,UAAW,IAAA,EAAA,EAAA,CAAO,cAAA,EAAgB,CAAA,CAAA;AAE/D,EAAA,KAAA,CAAM,cAAA,EAAgB,aAAA;AACtB,EAAA,KAAA,CAAM,YAAA,EAAc,WAAA;AACpB,EAAA,OAAO,KAAA;AACR,CAAA;AAEA,MAAA,SAAsB,KAAA,CAAS,KAAA,EAA8C,OAAA,EAAmC;AAC/G,EAAA,OAAO,IAAI,OAAA,CAAW,CAAC,OAAA,EAAS,MAAA,EAAA,GAAW;AAC1C,IAAA,QAAA,EAAU,EAAE,GAAG,QAAQ,CAAA;AACvB,IAAA,OAAA,CAAQ,gBAAA,IAAoB,CAAA,EAAA,GAAM;AAAA,IAAC,CAAA;AACnC,IAAA,OAAA,CAAQ,YAAA,IAAgB,CAAA,EAAA,GAAM,IAAA;AAC9B,IAAA,OAAA,CAAQ,QAAA,IAAY,EAAA;AAEpB,IAAA,MAAM,UAAA,EAA4B,8BAAA,OAAsB,CAAA;AAExD,IAAA,MAAM,QAAA,EAAU,CAAA,EAAA,GAAM;AACrB,MAAA,SAAA,CAAU,IAAA,CAAK,CAAA;AAAA,IAChB,CAAA;AAEA,IAAA,SAAA,CAAU,OAAA,CAAQ,MAAA,CAAO,aAAA,EAAA,GAA0B;AAClD,MAAA,IAAI;AACH,QAAA,MAAM,OAAA,EAAS,MAAM,KAAA,CAAM,aAAa,CAAA;AACxC,QAAA,OAAA,CAAQ,CAAA;AACR,QAAA,OAAA,CAAQ,MAAM,CAAA;AAAA,MACf,EAAA,MAAA,CAAS,KAAA,EAAO;AACf,QAAA,IAAI;AACH,UAAA,GAAA,CAAI,CAAA,CAAE,MAAA,WAAiB,KAAA,CAAA,EAAQ;AAC9B,YAAA,MAAM,IAAI,SAAA,CAAU,CAAA,uBAAA,EAA0B,KAAK,CAAA,gCAAA,CAAkC,CAAA;AAAA,UACtF;AAEA,UAAA,GAAA,CAAI,MAAA,WAAiB,UAAA,EAAY;AAChC,YAAA,MAAM,KAAA,CAAM,aAAA;AAAA,UACb;AAEA,UAAA,uBAAA,CAAwB,KAAA,EAAO,aAAA,EAAe,OAAO,CAAA;AAErD,UAAA,GAAA,CAAI,OAAA,CAAQ,YAAA,GAAe,CAAE,MAAM,OAAA,CAAQ,WAAA,CAAY,KAAK,CAAA,EAAI;AAC/D,YAAA,SAAA,CAAU,IAAA,CAAK,CAAA;AACf,YAAA,MAAA,CAAO,KAAK,CAAA;AAAA,UACb;AAEA,UAAA,OAAA,CAAQ,gBAAA,GAAoB,MAAM,OAAA,CAAQ,eAAA,CAAgB,KAAK,CAAA;AAE/D,UAAA,GAAA,CAAI,CAAC,SAAA,CAAU,KAAA,CAAM,KAAK,CAAA,EAAG;AAC5B,YAAA,MAAM,SAAA,CAAU,SAAA,CAAU,CAAA;AAAA,UAC3B;AAAA,QACD,EAAA,MAAA,CAAS,UAAA,EAAY;AACpB,UAAA,uBAAA,CAAwB,UAAA,EAA0B,aAAA,EAAe,OAAO,CAAA;AACxE,UAAA,OAAA,CAAQ,CAAA;AACR,UAAA,MAAA,CAAO,UAAU,CAAA;AAAA,QAClB;AAAA,MACD;AAAA,IACD,CAAC,CAAA;AAAA,EACF,CAAC,CAAA;AACF;AAEA,IAAO,cAAA,EAAQ,KAAA;ADvBf;AACA;AACE;AACA;AACA;AACF,8FAAC","file":"/home/runner/work/ts-utilities/ts-utilities/dist/chunk-C4CXLHXF.cjs","sourcesContent":[null,"/* eslint-disable @typescript-eslint/no-unused-expressions */\n// Ref: https://www.npmjs.com/package/p-retry\nimport { operation as retryOperation } from \"retry\"\n\nimport type { WrapOptions, RetryOperation } from \"retry\"\n\nexport class AbortError extends Error {\n\toriginalError: Error\n\n\tconstructor(message: string | Error) {\n\t\tsuper()\n\n\t\tif (message instanceof Error) {\n\t\t\tthis.originalError = message\n\t\t\t;({ message } = message)\n\t\t} else {\n\t\t\tthis.originalError = new Error(message)\n\t\t\tthis.originalError.stack = this.stack\n\t\t}\n\n\t\tthis.name = \"AbortError\"\n\t\tthis.message = message\n\t}\n}\n\nexport interface RetryOptions extends WrapOptions {\n\tonFailedAttempt?: (error: RetryError) => Promise<void> | void\n\tshouldRetry?: (error: RetryError) => Promise<boolean> | boolean\n}\n\ninterface RetryError extends Error {\n\tattemptNumber?: number\n\tretriesLeft?: number\n}\n\nconst decorateErrorWithCounts = (error: RetryError, attemptNumber: number, options: RetryOptions): RetryError => {\n\t// Minus 1 from attemptNumber because the first attempt does not count as a retry\n\tconst retriesLeft = (options.retries ?? 10) - (attemptNumber - 1)\n\n\terror.attemptNumber = attemptNumber\n\terror.retriesLeft = retriesLeft\n\treturn error\n}\n\nexport async function retry<T>(input: (attemptNumber: number) => Promise<T>, options: RetryOptions): Promise<T> {\n\treturn new Promise<T>((resolve, reject) => {\n\t\toptions = { ...options }\n\t\toptions.onFailedAttempt ??= () => {}\n\t\toptions.shouldRetry ??= () => true\n\t\toptions.retries ??= 10\n\n\t\tconst operation: RetryOperation = retryOperation(options)\n\n\t\tconst cleanUp = () => {\n\t\t\toperation.stop()\n\t\t}\n\n\t\toperation.attempt(async (attemptNumber: number) => {\n\t\t\ttry {\n\t\t\t\tconst result = await input(attemptNumber)\n\t\t\t\tcleanUp()\n\t\t\t\tresolve(result)\n\t\t\t} catch (error) {\n\t\t\t\ttry {\n\t\t\t\t\tif (!(error instanceof Error)) {\n\t\t\t\t\t\tthrow new TypeError(`Non-error was thrown: \"${error}\". You should only throw errors.`)\n\t\t\t\t\t}\n\n\t\t\t\t\tif (error instanceof AbortError) {\n\t\t\t\t\t\tthrow error.originalError\n\t\t\t\t\t}\n\n\t\t\t\t\tdecorateErrorWithCounts(error, attemptNumber, options)\n\n\t\t\t\t\tif (options.shouldRetry && !(await options.shouldRetry(error))) {\n\t\t\t\t\t\toperation.stop()\n\t\t\t\t\t\treject(error)\n\t\t\t\t\t}\n\n\t\t\t\t\toptions.onFailedAttempt && (await options.onFailedAttempt(error))\n\n\t\t\t\t\tif (!operation.retry(error)) {\n\t\t\t\t\t\tthrow operation.mainError()\n\t\t\t\t\t}\n\t\t\t\t} catch (finalError) {\n\t\t\t\t\tdecorateErrorWithCounts(finalError as RetryError, attemptNumber, options)\n\t\t\t\t\tcleanUp()\n\t\t\t\t\treject(finalError)\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t})\n}\n\nexport default retry\n"]}