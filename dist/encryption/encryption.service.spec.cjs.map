{"version":3,"sources":["/home/runner/work/ts-utilities/ts-utilities/dist/encryption/encryption.service.spec.cjs","../../src/encryption/encryption.service.spec.ts"],"names":[],"mappings":"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","file":"/home/runner/work/ts-utilities/ts-utilities/dist/encryption/encryption.service.spec.cjs","sourcesContent":[null,"import crypto from \"node:crypto\"\n\nimport { beforeEach, describe, expect, it, vi } from \"vitest\"\n\nimport { KMSClient } from \"@/kms\"\n\nimport { EnvelopeEncryptionService, type DEK, type EncryptedDEK } from \"./encryption.service\"\n\nimport { EncryptionModule } from \"./index\"\n\n// Mock the EncryptionModule\nvi.mock(\"./index\", () => ({\n\tEncryptionModule: {\n\t\tencrypt: vi.fn(),\n\t\tdecrypt: vi.fn(),\n\t\tgenerateEncryptionKey: vi.fn(),\n\t},\n}))\n\nconst mockEncrypt = vi.mocked(EncryptionModule.encrypt)\nconst mockDecrypt = vi.mocked(EncryptionModule.decrypt)\nconst mockGenerateEncryptionKey = vi.mocked(EncryptionModule.generateEncryptionKey)\n\n// Mock the KMS client - create a partial implementation\nconst mockKMSEncrypt = vi.fn<() => Promise<{ ciphertext: string; cryptoKeyVersion: string }>>()\nconst mockKMSDecrypt = vi.fn<() => Promise<string>>()\n\nconst mockKMSClient = {\n\tencrypt: mockKMSEncrypt,\n\tdecrypt: mockKMSDecrypt,\n} as unknown as KMSClient\n\n// Mock the SharedDEKDatagateway\nconst mockSharedDEKDatagateway = {\n\tgetDEK: vi.fn<() => Promise<EncryptedDEK | null>>(),\n\tinsertNewDEK: vi.fn<() => Promise<EncryptedDEK>>(),\n}\n\ndescribe(\"EnvelopeEncryptionService\", () => {\n\tlet service: EnvelopeEncryptionService\n\tlet config: { defaultVersion?: number }\n\n\tbeforeEach(() => {\n\t\tvi.clearAllMocks()\n\t\tconfig = {}\n\t\tservice = new EnvelopeEncryptionService(mockKMSClient, mockSharedDEKDatagateway, config)\n\t})\n\n\tdescribe(\"encrypt\", () => {\n\t\tconst testData = new Uint8Array(Buffer.from(\"hello world\"))\n\t\tconst testNonce = crypto.randomBytes(12)\n\t\tconst encryptedResult = {\n\t\t\tciphertext: \"encrypted-data\",\n\t\t\tnonce: testNonce,\n\t\t}\n\t\tconst dek: DEK = {\n\t\t\tversion: 1,\n\t\t\tdek: \"test-dek-key\",\n\t\t\tkekVersion: 1,\n\t\t}\n\n\t\tit(\"should encrypt data with specified DEK version\", async () => {\n\t\t\tmockSharedDEKDatagateway.getDEK.mockResolvedValue({\n\t\t\t\tversion: 1,\n\t\t\t\tencryptedDek: \"encrypted-dek\",\n\t\t\t\tkekVersion: 1,\n\t\t\t})\n\t\t\tmockKMSDecrypt.mockResolvedValue(dek.dek)\n\t\t\tmockEncrypt.mockResolvedValue(encryptedResult)\n\n\t\t\tconst result = await service.encrypt(testData, testNonce, 1)\n\n\t\t\texpect(mockSharedDEKDatagateway.getDEK).toHaveBeenCalledWith(1)\n\t\t\texpect(mockKMSDecrypt).toHaveBeenCalledWith(\"encrypted-dek\", \"1\")\n\t\t\texpect(EncryptionModule.encrypt).toHaveBeenCalledWith(testData, dek.dek, testNonce)\n\t\t\texpect(result).toEqual({\n\t\t\t\tdekVersion: 1,\n\t\t\t\tnonce: testNonce,\n\t\t\t\tciphertext: \"encrypted-data\",\n\t\t\t})\n\t\t})\n\n\t\tit(\"should encrypt data with default DEK version when not specified\", async () => {\n\t\t\tconfig.defaultVersion = 2\n\t\t\tmockSharedDEKDatagateway.getDEK.mockResolvedValue({\n\t\t\t\tversion: 2,\n\t\t\t\tencryptedDek: \"encrypted-dek\",\n\t\t\t\tkekVersion: 1,\n\t\t\t})\n\t\t\tmockKMSDecrypt.mockResolvedValue(dek.dek)\n\t\t\tmockEncrypt.mockResolvedValue(encryptedResult)\n\n\t\t\tconst result = await service.encrypt(testData, testNonce)\n\n\t\t\texpect(mockSharedDEKDatagateway.getDEK).toHaveBeenCalledWith(2)\n\t\t\texpect(result.dekVersion).toBe(2)\n\t\t})\n\n\t\tit(\"should throw error when DEK is not found\", async () => {\n\t\t\tmockSharedDEKDatagateway.getDEK.mockResolvedValue(null)\n\n\t\t\tawait expect(service.encrypt(testData, testNonce, 1)).rejects.toThrow(\"Failed to encrypt data, DEK not found\")\n\t\t})\n\n\t\tit(\"should use generated nonce when not provided\", async () => {\n\t\t\tmockSharedDEKDatagateway.getDEK.mockResolvedValue({\n\t\t\t\tversion: 1,\n\t\t\t\tencryptedDek: \"encrypted-dek\",\n\t\t\t\tkekVersion: 1,\n\t\t\t})\n\t\t\tmockKMSDecrypt.mockResolvedValue(dek.dek)\n\t\t\tmockEncrypt.mockResolvedValue(encryptedResult)\n\n\t\t\tconst result = await service.encrypt(testData)\n\n\t\t\texpect(EncryptionModule.encrypt).toHaveBeenCalledWith(testData, dek.dek, undefined)\n\t\t\texpect(result.nonce).toEqual(testNonce)\n\t\t})\n\t})\n\n\tdescribe(\"decrypt\", () => {\n\t\tconst ciphertext = \"encrypted-data\"\n\t\tconst nonce = crypto.randomBytes(12)\n\t\tconst decryptedData = new Uint8Array(Buffer.from(\"hello world\"))\n\t\tconst dek: DEK = {\n\t\t\tversion: 1,\n\t\t\tdek: \"test-dek-key\",\n\t\t\tkekVersion: 1,\n\t\t}\n\n\t\tit(\"should decrypt data successfully\", async () => {\n\t\t\tmockSharedDEKDatagateway.getDEK.mockResolvedValue({\n\t\t\t\tversion: 1,\n\t\t\t\tencryptedDek: \"encrypted-dek\",\n\t\t\t\tkekVersion: 1,\n\t\t\t})\n\t\t\tmockKMSDecrypt.mockResolvedValue(dek.dek)\n\t\t\tmockDecrypt.mockResolvedValue(decryptedData)\n\n\t\t\tconst result = await service.decrypt(ciphertext, nonce, 1)\n\n\t\t\texpect(mockSharedDEKDatagateway.getDEK).toHaveBeenCalledWith(1)\n\t\t\texpect(mockKMSDecrypt).toHaveBeenCalledWith(\"encrypted-dek\", \"1\")\n\t\t\texpect(EncryptionModule.decrypt).toHaveBeenCalledWith(ciphertext, nonce, dek.dek)\n\t\t\texpect(result).toEqual(decryptedData)\n\t\t})\n\n\t\tit(\"should throw error when DEK is not found\", async () => {\n\t\t\tmockSharedDEKDatagateway.getDEK.mockResolvedValue(null)\n\n\t\t\tawait expect(service.decrypt(ciphertext, nonce, 1)).rejects.toThrow(\"Failed to decrypt data, DEK not found\")\n\t\t})\n\t})\n\n\tdescribe(\"rotateDEK\", () => {\n\t\tconst newDek = \"new-generated-dek\"\n\t\tconst encryptedDek = \"kms-encrypted-dek\"\n\t\tconst cryptoKeyVersion = \"1\"\n\t\tconst insertedDek: EncryptedDEK = {\n\t\t\tversion: 2,\n\t\t\tencryptedDek,\n\t\t\tkekVersion: 1,\n\t\t}\n\n\t\tit(\"should rotate DEK successfully\", async () => {\n\t\t\tmockGenerateEncryptionKey.mockReturnValue(newDek)\n\t\t\tmockKMSEncrypt.mockResolvedValue({\n\t\t\t\tciphertext: encryptedDek,\n\t\t\t\tcryptoKeyVersion,\n\t\t\t})\n\t\t\tmockSharedDEKDatagateway.insertNewDEK.mockResolvedValue(insertedDek)\n\n\t\t\tconst result = await service.rotateDEK()\n\n\t\t\texpect(EncryptionModule.generateEncryptionKey).toHaveBeenCalledWith(\"hex\")\n\t\t\texpect(mockKMSEncrypt).toHaveBeenCalledWith(newDek, undefined)\n\t\t\texpect(mockSharedDEKDatagateway.insertNewDEK).toHaveBeenCalledWith(encryptedDek, 1)\n\t\t\texpect(result).toBe(2)\n\t\t})\n\n\t\tit(\"should rotate DEK with specific KEK version\", async () => {\n\t\t\tconst kekVersion = \"2\"\n\t\t\tmockGenerateEncryptionKey.mockReturnValue(newDek)\n\t\t\tmockKMSEncrypt.mockResolvedValue({\n\t\t\t\tciphertext: encryptedDek,\n\t\t\t\tcryptoKeyVersion,\n\t\t\t})\n\t\t\tmockSharedDEKDatagateway.insertNewDEK.mockResolvedValue(insertedDek)\n\n\t\t\tconst result = await service.rotateDEK(kekVersion)\n\n\t\t\texpect(mockKMSEncrypt).toHaveBeenCalledWith(newDek, kekVersion)\n\t\t\texpect(result).toBe(2)\n\t\t})\n\t})\n\n\tdescribe(\"#getDEK (private method testing via caching behavior)\", () => {\n\t\tconst dek: DEK = {\n\t\t\tversion: 1,\n\t\t\tdek: \"test-dek-key\",\n\t\t\tkekVersion: 1,\n\t\t}\n\t\tconst encryptedDek: EncryptedDEK = {\n\t\t\tversion: 1,\n\t\t\tencryptedDek: \"encrypted-dek\",\n\t\t\tkekVersion: 1,\n\t\t}\n\n\t\tit(\"should cache DEK after first retrieval\", async () => {\n\t\t\tmockSharedDEKDatagateway.getDEK.mockResolvedValue(encryptedDek)\n\t\t\tmockKMSDecrypt.mockResolvedValue(dek.dek)\n\n\t\t\t// First call should fetch from database and decrypt\n\t\t\tawait service.encrypt(new Uint8Array(Buffer.from(\"test\")), null, 1)\n\t\t\texpect(mockSharedDEKDatagateway.getDEK).toHaveBeenCalledTimes(1)\n\t\t\texpect(mockKMSDecrypt).toHaveBeenCalledTimes(1)\n\n\t\t\t// Second call should use cache\n\t\t\tawait service.encrypt(new Uint8Array(Buffer.from(\"test\")), null, 1)\n\t\t\texpect(mockSharedDEKDatagateway.getDEK).toHaveBeenCalledTimes(1)\n\t\t\texpect(mockKMSDecrypt).toHaveBeenCalledTimes(1)\n\t\t})\n\n\t\tit(\"should not cache when DEK is not found\", async () => {\n\t\t\tmockSharedDEKDatagateway.getDEK.mockResolvedValue(null)\n\n\t\t\tawait expect(service.encrypt(new Uint8Array(Buffer.from(\"test\")), null, 1)).rejects.toThrow()\n\n\t\t\t// Should still try to fetch on next call\n\t\t\tawait expect(service.encrypt(new Uint8Array(Buffer.from(\"test\")), null, 1)).rejects.toThrow()\n\t\t\texpect(mockSharedDEKDatagateway.getDEK).toHaveBeenCalledTimes(2)\n\t\t})\n\n\t\tit(\"should use default version when no version specified\", async () => {\n\t\t\tconfig.defaultVersion = 5\n\t\t\tmockSharedDEKDatagateway.getDEK.mockResolvedValue(encryptedDek)\n\t\t\tmockKMSDecrypt.mockResolvedValue(dek.dek)\n\n\t\t\tawait service.encrypt(new Uint8Array(Buffer.from(\"test\")), null)\n\n\t\t\texpect(mockSharedDEKDatagateway.getDEK).toHaveBeenCalledWith(5)\n\t\t})\n\t})\n\n\tdescribe(\"error handling\", () => {\n\t\tit(\"should propagate errors from KMS client\", async () => {\n\t\t\tmockSharedDEKDatagateway.getDEK.mockResolvedValue({\n\t\t\t\tversion: 1,\n\t\t\t\tencryptedDek: \"encrypted-dek\",\n\t\t\t\tkekVersion: 1,\n\t\t\t})\n\t\t\tmockKMSDecrypt.mockRejectedValue(new Error(\"KMS error\"))\n\n\t\t\tawait expect(service.encrypt(new Uint8Array(Buffer.from(\"test\")), null, 1)).rejects.toThrow(\"KMS error\")\n\t\t})\n\n\t\tit(\"should propagate errors from EncryptionModule\", async () => {\n\t\t\tmockSharedDEKDatagateway.getDEK.mockResolvedValue({\n\t\t\t\tversion: 1,\n\t\t\t\tencryptedDek: \"encrypted-dek\",\n\t\t\t\tkekVersion: 1,\n\t\t\t})\n\t\t\tmockKMSDecrypt.mockResolvedValue(\"test-dek-key\")\n\t\t\tmockEncrypt.mockRejectedValue(new Error(\"Encryption error\"))\n\n\t\t\tawait expect(service.encrypt(new Uint8Array(Buffer.from(\"test\")), null, 1)).rejects.toThrow(\"Encryption error\")\n\t\t})\n\n\t\tit(\"should propagate errors from SharedDEKDatagateway\", async () => {\n\t\t\tmockSharedDEKDatagateway.getDEK.mockRejectedValue(new Error(\"Database error\"))\n\n\t\t\tawait expect(service.encrypt(new Uint8Array(Buffer.from(\"test\")), null, 1)).rejects.toThrow(\"Database error\")\n\t\t})\n\t})\n\n\tdescribe(\"integration scenarios\", () => {\n\t\tit(\"should handle full encrypt/decrypt cycle\", async () => {\n\t\t\tconst originalData = new Uint8Array(Buffer.from(\"secret data\"))\n\t\t\tconst dek: DEK = {\n\t\t\t\tversion: 1,\n\t\t\t\tdek: \"test-dek-key\",\n\t\t\t\tkekVersion: 1,\n\t\t\t}\n\n\t\t\t// Setup mocks for encrypt\n\t\t\tmockSharedDEKDatagateway.getDEK.mockResolvedValue({\n\t\t\t\tversion: 1,\n\t\t\t\tencryptedDek: \"encrypted-dek\",\n\t\t\t\tkekVersion: 1,\n\t\t\t})\n\t\t\tmockKMSDecrypt.mockResolvedValue(dek.dek)\n\t\t\tmockEncrypt.mockResolvedValue({\n\t\t\t\tciphertext: \"encrypted-payload\",\n\t\t\t\tnonce: crypto.randomBytes(12),\n\t\t\t})\n\n\t\t\t// Encrypt\n\t\t\tconst encryptResult = await service.encrypt(originalData, null, 1)\n\n\t\t\t// Setup mocks for decrypt (same DEK should be cached)\n\t\t\tmockDecrypt.mockResolvedValue(originalData)\n\n\t\t\t// Decrypt\n\t\t\tconst decryptResult = await service.decrypt(\n\t\t\t\tencryptResult.ciphertext,\n\t\t\t\tencryptResult.nonce,\n\t\t\t\tencryptResult.dekVersion,\n\t\t\t)\n\n\t\t\texpect(decryptResult).toEqual(originalData)\n\t\t\t// Should use cached DEK\n\t\t\texpect(mockSharedDEKDatagateway.getDEK).toHaveBeenCalledTimes(1)\n\t\t\texpect(mockKMSDecrypt).toHaveBeenCalledTimes(1)\n\t\t})\n\t})\n})\n"]}