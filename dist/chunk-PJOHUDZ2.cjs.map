{"version":3,"sources":["/home/runner/work/ts-utilities/ts-utilities/dist/chunk-PJOHUDZ2.cjs","../src/utils/sync/mutexWithKey.ts"],"names":[],"mappings":"AAAA;AACE;AACF,wDAA6B;AAC7B;AACA;ACJA,8CAAA,CAAA;AAAA,yCAAsB;AAMf,IAAM,aAAA,YAAN,MAAmB;AAAA,EACzB,4BAAe,MAAA,kBAAQ,IAAI,GAAA,CAAmB,EAAA;AAAA,EAC9C,6BAAe,cAAA,EAAgB,IAAI,sBAAA,CAAM,EAAA;AAAA,EAEzC,OAAA,MAAa,QAAA,CAAY,GAAA,EAAa,EAAA,EAAkC;AACvE,IAAA,IAAI,KAAA;AAGJ,IAAA,MAAM,IAAA,CAAK,aAAA,CAAc,YAAA,CAAa,CAAA,EAAA,GAAM;AAC3C,MAAA,MAAA,mBAAQ,IAAA,CAAK,KAAA,CAAM,GAAA,CAAI,GAAG,CAAA,UAAK,IAAI,sBAAA,CAAM,GAAA;AACzC,MAAA,IAAA,CAAK,KAAA,CAAM,GAAA,CAAI,GAAA,EAAK,KAAK,CAAA;AAAA,IAC1B,CAAC,CAAA;AAGD,IAAA,OAAO,KAAA,CAAO,YAAA,CAAa,EAAE,CAAA;AAAA,EAC9B;AACD,yDAAA;ADHA;AACA;AACE;AACF,oCAAC","file":"/home/runner/work/ts-utilities/ts-utilities/dist/chunk-PJOHUDZ2.cjs","sourcesContent":[null,"import { Mutex } from \"async-mutex\"\n\n/**\n * Provides per-key mutual exclusion using async-mutex.\n * This only works on a single thread.\n */\nexport class MutexWithKey {\n\tprivate static locks = new Map<string, Mutex>()\n\tprivate static creationMutex = new Mutex()\n\n\tstatic async withLock<T>(key: string, fn: () => Promise<T>): Promise<T> {\n\t\tlet mutex: Mutex\n\n\t\t// Ensure only one mutex is created per key\n\t\tawait this.creationMutex.runExclusive(() => {\n\t\t\tmutex = this.locks.get(key) ?? new Mutex()\n\t\t\tthis.locks.set(key, mutex)\n\t\t})\n\n\t\t// Run the actual function under the per-key mutex\n\t\treturn mutex!.runExclusive(fn)\n\t}\n}\n"]}