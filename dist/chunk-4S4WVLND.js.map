{"version":3,"sources":["../src/storage/helper.ts"],"sourcesContent":["import mime from \"mime\"\nimport { VError } from \"verror\"\n\nimport { CloudStorageService } from \"./cloud-storage\"\nimport { OneDriveService } from \"./onedrive\"\nimport { FileUri } from \"./type\"\n\n/**\n * Facade layer for file operations (GCS/OneDrive/SharePoint/Public)\n */\nexport class FileHelper {\n\t/**\n\t * Extract file URI information from the given URI.\n\t * alias for `decodeUri`\n\t */\n\tstatic extractFileUri(fileUrl: string): FileUri {\n\t\treturn FileHelper.decodeUri(fileUrl)\n\t}\n\n\t/**\n\t * Decode file URI information from the given URI\n\t * - CloudStorage\n\t *   - `gs://{bucketName}/{filePath}`\n\t *   - `https://storage.googleapis.com/{bucketName}/{filePath}`\n\t *   - `https://{bucketName}.storage.googleapis.com/{filePath}`\n\t * - OneDrive - `onedrive://{driveId}/{itemId}`\n\t * - SharePoint - `sharepoint://{siteId}/{driveId}/{itemId}`\n\t * - Public - `https://{publicUrl}` | `http://{publicUrl}`\n\t */\n\tstatic decodeUri(fileUrl: string): FileUri {\n\t\ttry {\n\t\t\tconst url = new URL(fileUrl)\n\n\t\t\tswitch (url.protocol) {\n\t\t\t\tcase \"gs:\": {\n\t\t\t\t\tconst bucketName = url.hostname\n\t\t\t\t\tconst filePath = url.pathname.startsWith(\"/\") ? url.pathname.slice(1) : url.pathname\n\t\t\t\t\tif (!bucketName || !filePath) {\n\t\t\t\t\t\tthrow new VError(`Invalid GCS URL format, expecting 'gs://{bucketName}/{filePath}'`)\n\t\t\t\t\t}\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttype: \"gcs\",\n\t\t\t\t\t\turi: `gs://${bucketName}/${decodeURIComponent(filePath)}`,\n\t\t\t\t\t\tbucketName,\n\t\t\t\t\t\tfilePath,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcase \"onedrive:\": {\n\t\t\t\t\tlet driveId = url.hostname\n\t\t\t\t\tlet itemId = url.pathname.startsWith(\"/\") ? url.pathname.slice(1) : url.pathname\n\t\t\t\t\tif (!driveId || !itemId) {\n\t\t\t\t\t\tthrow new VError(`Invalid OneDrive URL format, expecting 'onedrive://{driveId}/{itemId}'`)\n\t\t\t\t\t}\n\n\t\t\t\t\tdriveId = OneDriveService.formatDriveId(driveId)\n\t\t\t\t\titemId = OneDriveService.formatItemId(itemId)\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttype: \"onedrive\",\n\t\t\t\t\t\turi: `onedrive://${driveId}/${itemId}`,\n\t\t\t\t\t\tdriveId,\n\t\t\t\t\t\titemId,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcase \"sharepoint:\": {\n\t\t\t\t\tconst siteId = url.hostname\n\t\t\t\t\tconst pathParts = (url.pathname.startsWith(\"/\") ? url.pathname.slice(1) : url.pathname).split(\"/\")\n\t\t\t\t\tif (pathParts.length < 2) {\n\t\t\t\t\t\tthrow new VError(`Invalid SharePoint URL format, expecting 'sharepoint://{siteId}/{driveId}/{itemId}'`)\n\t\t\t\t\t}\n\n\t\t\t\t\tconst driveId = OneDriveService.formatDriveId(pathParts[0] ?? \"\")\n\t\t\t\t\tconst itemId = OneDriveService.formatItemId(pathParts[1] ?? \"\")\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttype: \"sharepoint\",\n\t\t\t\t\t\turi: `sharepoint://${siteId}/${driveId}/${itemId}`,\n\t\t\t\t\t\tsiteId,\n\t\t\t\t\t\tdriveId,\n\t\t\t\t\t\titemId,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcase \"http:\":\n\t\t\t\tcase \"https:\": {\n\t\t\t\t\tif (CloudStorageService.isGCSUrl(fileUrl)) {\n\t\t\t\t\t\tconst info = CloudStorageService.extractInfo(fileUrl)\n\t\t\t\t\t\tif (!info) {\n\t\t\t\t\t\t\tthrow new VError(`Invalid GCS URL format, expecting 'gs://{bucketName}/{filePath}'`)\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\ttype: \"gcs\",\n\t\t\t\t\t\t\turi: CloudStorageService.toGCSUri(info),\n\t\t\t\t\t\t\tbucketName: info.bucketName,\n\t\t\t\t\t\t\tfilePath: info.filePath,\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttype: \"public\",\n\t\t\t\t\t\turi: fileUrl,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t\tthrow new VError(`Unsupported file URL scheme: ${url.protocol}`)\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tif (error instanceof VError) {\n\t\t\t\tthrow error\n\t\t\t}\n\t\t\tthrow new VError({ cause: error as Error }, `Invalid file URL: ${fileUrl}`)\n\t\t}\n\t}\n\n\t/**\n\t * Encode file URI information to a string.\n\t * - CloudStorage\n\t *   - `gs://{bucketName}/{filePath}`\n\t *   - `https://storage.googleapis.com/{bucketName}/{filePath}`\n\t *   - `https://{bucketName}.storage.googleapis.com/{filePath}`\n\t * - OneDrive - `onedrive://{driveId}/{itemId}`\n\t * - SharePoint - `sharepoint://{siteId}/{driveId}/{itemId}`\n\t * - Public - `https://{publicUrl}` | `http://{publicUrl}`\n\t */\n\tstatic encodeUri(fileUri: FileUri): string {\n\t\tswitch (fileUri.type) {\n\t\t\tcase \"gcs\":\n\t\t\t\treturn `gs://${fileUri.bucketName}/${fileUri.filePath}`\n\t\t\tcase \"onedrive\":\n\t\t\t\treturn `onedrive://${OneDriveService.formatDriveId(fileUri.driveId)}/${OneDriveService.formatItemId(fileUri.itemId)}`\n\t\t\tcase \"sharepoint\":\n\t\t\t\treturn `sharepoint://${fileUri.siteId}/${OneDriveService.formatDriveId(fileUri.driveId)}/${OneDriveService.formatItemId(fileUri.itemId)}`\n\t\t\tcase \"public\":\n\t\t\t\treturn fileUri.uri\n\t\t\tdefault:\n\t\t\t\tthrow new VError(`Unsupported file URI type: ${fileUri}`)\n\t\t}\n\t}\n\n\t/**\n\t * Get the file extension from the MIME type\n\t */\n\tstatic mimeFileExtension(mimeType: string): string | null {\n\t\tconst extension = mime.getExtension(mimeType)\n\t\tif (!extension) {\n\t\t\treturn fallbackMimeToExt[mimeType] || null\n\t\t}\n\t\treturn extension\n\t}\n}\n\nconst fallbackMimeToExt: Record<string, string> = {\n\t\"application/pdf\": \"pdf\",\n\t\"application/msword\": \"doc\",\n\t\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\": \"docx\",\n\t\"application/vnd.ms-excel\": \"xls\",\n\t\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\": \"xlsx\",\n\t\"application/vnd.ms-powerpoint\": \"ppt\",\n\t\"application/vnd.openxmlformats-officedocument.presentationml.presentation\": \"pptx\",\n\t\"application/json\": \"json\",\n\t\"application/xml\": \"xml\",\n\t\"application/yaml\": \"yaml\",\n\t\"application/toml\": \"toml\",\n\t\"application/html\": \"html\",\n\t\"application/css\": \"css\",\n\t\"application/javascript\": \"js\",\n\t\"application/typescript\": \"ts\",\n}\n"],"mappings":";;;;;;;;AAAA,OAAO,UAAU;AACjB,SAAS,cAAc;AAShB,IAAM,aAAN,MAAM,YAAW;AAAA;AAAA;AAAA;AAAA;AAAA,EAKvB,OAAO,eAAe,SAA0B;AAC/C,WAAO,YAAW,UAAU,OAAO;AAAA,EACpC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAYA,OAAO,UAAU,SAA0B;AAC1C,QAAI;AACH,YAAM,MAAM,IAAI,IAAI,OAAO;AAE3B,cAAQ,IAAI,UAAU;AAAA,QACrB,KAAK,OAAO;AACX,gBAAM,aAAa,IAAI;AACvB,gBAAM,WAAW,IAAI,SAAS,WAAW,GAAG,IAAI,IAAI,SAAS,MAAM,CAAC,IAAI,IAAI;AAC5E,cAAI,CAAC,cAAc,CAAC,UAAU;AAC7B,kBAAM,IAAI,OAAO,kEAAkE;AAAA,UACpF;AACA,iBAAO;AAAA,YACN,MAAM;AAAA,YACN,KAAK,QAAQ,UAAU,IAAI,mBAAmB,QAAQ,CAAC;AAAA,YACvD;AAAA,YACA;AAAA,UACD;AAAA,QACD;AAAA,QACA,KAAK,aAAa;AACjB,cAAI,UAAU,IAAI;AAClB,cAAI,SAAS,IAAI,SAAS,WAAW,GAAG,IAAI,IAAI,SAAS,MAAM,CAAC,IAAI,IAAI;AACxE,cAAI,CAAC,WAAW,CAAC,QAAQ;AACxB,kBAAM,IAAI,OAAO,wEAAwE;AAAA,UAC1F;AAEA,oBAAU,gBAAgB,cAAc,OAAO;AAC/C,mBAAS,gBAAgB,aAAa,MAAM;AAE5C,iBAAO;AAAA,YACN,MAAM;AAAA,YACN,KAAK,cAAc,OAAO,IAAI,MAAM;AAAA,YACpC;AAAA,YACA;AAAA,UACD;AAAA,QACD;AAAA,QACA,KAAK,eAAe;AACnB,gBAAM,SAAS,IAAI;AACnB,gBAAM,aAAa,IAAI,SAAS,WAAW,GAAG,IAAI,IAAI,SAAS,MAAM,CAAC,IAAI,IAAI,UAAU,MAAM,GAAG;AACjG,cAAI,UAAU,SAAS,GAAG;AACzB,kBAAM,IAAI,OAAO,qFAAqF;AAAA,UACvG;AAEA,gBAAM,UAAU,gBAAgB,cAAc,UAAU,CAAC,KAAK,EAAE;AAChE,gBAAM,SAAS,gBAAgB,aAAa,UAAU,CAAC,KAAK,EAAE;AAE9D,iBAAO;AAAA,YACN,MAAM;AAAA,YACN,KAAK,gBAAgB,MAAM,IAAI,OAAO,IAAI,MAAM;AAAA,YAChD;AAAA,YACA;AAAA,YACA;AAAA,UACD;AAAA,QACD;AAAA,QACA,KAAK;AAAA,QACL,KAAK,UAAU;AACd,cAAI,oBAAoB,SAAS,OAAO,GAAG;AAC1C,kBAAM,OAAO,oBAAoB,YAAY,OAAO;AACpD,gBAAI,CAAC,MAAM;AACV,oBAAM,IAAI,OAAO,kEAAkE;AAAA,YACpF;AACA,mBAAO;AAAA,cACN,MAAM;AAAA,cACN,KAAK,oBAAoB,SAAS,IAAI;AAAA,cACtC,YAAY,KAAK;AAAA,cACjB,UAAU,KAAK;AAAA,YAChB;AAAA,UACD;AACA,iBAAO;AAAA,YACN,MAAM;AAAA,YACN,KAAK;AAAA,UACN;AAAA,QACD;AAAA,QACA;AACC,gBAAM,IAAI,OAAO,gCAAgC,IAAI,QAAQ,EAAE;AAAA,MACjE;AAAA,IACD,SAAS,OAAO;AACf,UAAI,iBAAiB,QAAQ;AAC5B,cAAM;AAAA,MACP;AACA,YAAM,IAAI,OAAO,EAAE,OAAO,MAAe,GAAG,qBAAqB,OAAO,EAAE;AAAA,IAC3E;AAAA,EACD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAYA,OAAO,UAAU,SAA0B;AAC1C,YAAQ,QAAQ,MAAM;AAAA,MACrB,KAAK;AACJ,eAAO,QAAQ,QAAQ,UAAU,IAAI,QAAQ,QAAQ;AAAA,MACtD,KAAK;AACJ,eAAO,cAAc,gBAAgB,cAAc,QAAQ,OAAO,CAAC,IAAI,gBAAgB,aAAa,QAAQ,MAAM,CAAC;AAAA,MACpH,KAAK;AACJ,eAAO,gBAAgB,QAAQ,MAAM,IAAI,gBAAgB,cAAc,QAAQ,OAAO,CAAC,IAAI,gBAAgB,aAAa,QAAQ,MAAM,CAAC;AAAA,MACxI,KAAK;AACJ,eAAO,QAAQ;AAAA,MAChB;AACC,cAAM,IAAI,OAAO,8BAA8B,OAAO,EAAE;AAAA,IAC1D;AAAA,EACD;AAAA;AAAA;AAAA;AAAA,EAKA,OAAO,kBAAkB,UAAiC;AACzD,UAAM,YAAY,KAAK,aAAa,QAAQ;AAC5C,QAAI,CAAC,WAAW;AACf,aAAO,kBAAkB,QAAQ,KAAK;AAAA,IACvC;AACA,WAAO;AAAA,EACR;AACD;AAEA,IAAM,oBAA4C;AAAA,EACjD,mBAAmB;AAAA,EACnB,sBAAsB;AAAA,EACtB,2EAA2E;AAAA,EAC3E,4BAA4B;AAAA,EAC5B,qEAAqE;AAAA,EACrE,iCAAiC;AAAA,EACjC,6EAA6E;AAAA,EAC7E,oBAAoB;AAAA,EACpB,mBAAmB;AAAA,EACnB,oBAAoB;AAAA,EACpB,oBAAoB;AAAA,EACpB,oBAAoB;AAAA,EACpB,mBAAmB;AAAA,EACnB,0BAA0B;AAAA,EAC1B,0BAA0B;AAC3B;","names":[]}