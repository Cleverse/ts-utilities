{"version":3,"sources":["../../../src/utils/miscellaneous/jsonl.spec.ts"],"sourcesContent":["import { describe, expect, it } from \"vitest\"\n\nimport { jsonlDecodeStream, jsonlDecodeStreamAsync } from \"./jsonl\"\n\ndescribe(\"miscellaneous/jsonl\", () => {\n\tconst createStream = (chunks: string[]) => {\n\t\treturn new ReadableStream({\n\t\t\tstart(controller) {\n\t\t\t\tfor (const chunk of chunks) {\n\t\t\t\t\tcontroller.enqueue(new TextEncoder().encode(chunk))\n\t\t\t\t}\n\t\t\t\tcontroller.close()\n\t\t\t},\n\t\t})\n\t}\n\n\tdescribe(\"jsonlDecodeStreamAsync\", () => {\n\t\tit(\"should decode valid JSONL stream\", async () => {\n\t\t\tconst chunks = ['{\"id\":1}\\n{\"id\":2}\\n', '{\"id\":3}']\n\t\t\tconst stream = createStream(chunks)\n\t\t\tconst result: unknown[] = []\n\n\t\t\tfor await (const item of jsonlDecodeStreamAsync(stream)) {\n\t\t\t\tresult.push(item)\n\t\t\t}\n\n\t\t\texpect(result).toEqual([{ id: 1 }, { id: 2 }, { id: 3 }])\n\t\t})\n\n\t\tit(\"should handle split lines across chunks\", async () => {\n\t\t\tconst chunks = ['{\"id\":1}\\n{\"id\"', ':2}\\n{\"id\":3}']\n\t\t\tconst stream = createStream(chunks)\n\t\t\tconst result: unknown[] = []\n\n\t\t\tfor await (const item of jsonlDecodeStreamAsync(stream)) {\n\t\t\t\tresult.push(item)\n\t\t\t}\n\n\t\t\texpect(result).toEqual([{ id: 1 }, { id: 2 }, { id: 3 }])\n\t\t})\n\n\t\tit(\"should throw error on invalid JSON\", async () => {\n\t\t\tconst stream = createStream(['{\"id\":1}\\ninvalid-json\\n'])\n\n\t\t\tawait expect(async () => {\n\t\t\t\tfor await (const _ of jsonlDecodeStreamAsync(stream)) {\n\t\t\t\t\t// consume\n\t\t\t\t}\n\t\t\t}).rejects.toThrow(\"Failed to parse JSONL line\")\n\t\t})\n\n\t\tit(\"should skip invalid lines if requested\", async () => {\n\t\t\tconst stream = createStream(['{\"id\":1}\\ninvalid-json\\n{\"id\":2}'])\n\t\t\tconst result: unknown[] = []\n\n\t\t\tfor await (const item of jsonlDecodeStreamAsync(stream, { skipInvalidLine: true })) {\n\t\t\t\tresult.push(item)\n\t\t\t}\n\n\t\t\texpect(result).toEqual([{ id: 1 }, { id: 2 }])\n\t\t})\n\t})\n\n\tdescribe(\"jsonlDecodeStream\", () => {\n\t\tit(\"should decode stream to array\", async () => {\n\t\t\tconst stream = createStream(['{\"a\":1}\\n{\"b\":2}'])\n\t\t\tconst result = await jsonlDecodeStream(stream)\n\t\t\texpect(result).toEqual([{ a: 1 }, { b: 2 }])\n\t\t})\n\t})\n})\n"],"mappings":"AAAA,SAAS,UAAU,QAAQ,UAAU;AAErC,SAAS,mBAAmB,8BAA8B;AAE1D,SAAS,uBAAuB,MAAM;AACrC,QAAM,eAAe,CAAC,WAAqB;AAC1C,WAAO,IAAI,eAAe;AAAA,MACzB,MAAM,YAAY;AACjB,mBAAW,SAAS,QAAQ;AAC3B,qBAAW,QAAQ,IAAI,YAAY,EAAE,OAAO,KAAK,CAAC;AAAA,QACnD;AACA,mBAAW,MAAM;AAAA,MAClB;AAAA,IACD,CAAC;AAAA,EACF;AAEA,WAAS,0BAA0B,MAAM;AACxC,OAAG,oCAAoC,YAAY;AAClD,YAAM,SAAS,CAAC,wBAAwB,UAAU;AAClD,YAAM,SAAS,aAAa,MAAM;AAClC,YAAM,SAAoB,CAAC;AAE3B,uBAAiB,QAAQ,uBAAuB,MAAM,GAAG;AACxD,eAAO,KAAK,IAAI;AAAA,MACjB;AAEA,aAAO,MAAM,EAAE,QAAQ,CAAC,EAAE,IAAI,EAAE,GAAG,EAAE,IAAI,EAAE,GAAG,EAAE,IAAI,EAAE,CAAC,CAAC;AAAA,IACzD,CAAC;AAED,OAAG,2CAA2C,YAAY;AACzD,YAAM,SAAS,CAAC,mBAAmB,eAAe;AAClD,YAAM,SAAS,aAAa,MAAM;AAClC,YAAM,SAAoB,CAAC;AAE3B,uBAAiB,QAAQ,uBAAuB,MAAM,GAAG;AACxD,eAAO,KAAK,IAAI;AAAA,MACjB;AAEA,aAAO,MAAM,EAAE,QAAQ,CAAC,EAAE,IAAI,EAAE,GAAG,EAAE,IAAI,EAAE,GAAG,EAAE,IAAI,EAAE,CAAC,CAAC;AAAA,IACzD,CAAC;AAED,OAAG,sCAAsC,YAAY;AACpD,YAAM,SAAS,aAAa,CAAC,0BAA0B,CAAC;AAExD,YAAM,OAAO,YAAY;AACxB,yBAAiB,KAAK,uBAAuB,MAAM,GAAG;AAAA,QAEtD;AAAA,MACD,CAAC,EAAE,QAAQ,QAAQ,4BAA4B;AAAA,IAChD,CAAC;AAED,OAAG,0CAA0C,YAAY;AACxD,YAAM,SAAS,aAAa,CAAC,kCAAkC,CAAC;AAChE,YAAM,SAAoB,CAAC;AAE3B,uBAAiB,QAAQ,uBAAuB,QAAQ,EAAE,iBAAiB,KAAK,CAAC,GAAG;AACnF,eAAO,KAAK,IAAI;AAAA,MACjB;AAEA,aAAO,MAAM,EAAE,QAAQ,CAAC,EAAE,IAAI,EAAE,GAAG,EAAE,IAAI,EAAE,CAAC,CAAC;AAAA,IAC9C,CAAC;AAAA,EACF,CAAC;AAED,WAAS,qBAAqB,MAAM;AACnC,OAAG,iCAAiC,YAAY;AAC/C,YAAM,SAAS,aAAa,CAAC,kBAAkB,CAAC;AAChD,YAAM,SAAS,MAAM,kBAAkB,MAAM;AAC7C,aAAO,MAAM,EAAE,QAAQ,CAAC,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,CAAC,CAAC;AAAA,IAC5C,CAAC;AAAA,EACF,CAAC;AACF,CAAC;","names":[]}