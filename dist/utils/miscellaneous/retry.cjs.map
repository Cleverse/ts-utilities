{"version":3,"sources":["../../../src/utils/miscellaneous/retry.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unused-expressions */\n// Ref: https://www.npmjs.com/package/p-retry\nimport { operation as retryOperation } from \"retry\"\n\nimport type { WrapOptions, RetryOperation } from \"retry\"\n\nexport class AbortError extends Error {\n\toriginalError: Error\n\n\tconstructor(message: string | Error) {\n\t\tsuper()\n\n\t\tif (message instanceof Error) {\n\t\t\tthis.originalError = message\n\t\t\t;({ message } = message)\n\t\t} else {\n\t\t\tthis.originalError = new Error(message)\n\t\t\tthis.originalError.stack = this.stack\n\t\t}\n\n\t\tthis.name = \"AbortError\"\n\t\tthis.message = message\n\t}\n}\n\nexport interface RetryOptions extends WrapOptions {\n\tonFailedAttempt?: (error: RetryError) => Promise<void> | void\n\tshouldRetry?: (error: RetryError) => Promise<boolean> | boolean\n}\n\ninterface RetryError extends Error {\n\tattemptNumber?: number\n\tretriesLeft?: number\n}\n\nconst decorateErrorWithCounts = (error: RetryError, attemptNumber: number, options: RetryOptions): RetryError => {\n\t// Minus 1 from attemptNumber because the first attempt does not count as a retry\n\tconst retriesLeft = (options.retries ?? 10) - (attemptNumber - 1)\n\n\terror.attemptNumber = attemptNumber\n\terror.retriesLeft = retriesLeft\n\treturn error\n}\n\nexport async function retry<T>(input: (attemptNumber: number) => Promise<T>, options: RetryOptions): Promise<T> {\n\treturn new Promise<T>((resolve, reject) => {\n\t\toptions = { ...options }\n\t\toptions.onFailedAttempt ??= () => {}\n\t\toptions.shouldRetry ??= () => true\n\t\toptions.retries ??= 10\n\n\t\tconst operation: RetryOperation = retryOperation(options)\n\n\t\tconst cleanUp = () => {\n\t\t\toperation.stop()\n\t\t}\n\n\t\toperation.attempt(async (attemptNumber: number) => {\n\t\t\ttry {\n\t\t\t\tconst result = await input(attemptNumber)\n\t\t\t\tcleanUp()\n\t\t\t\tresolve(result)\n\t\t\t} catch (error) {\n\t\t\t\ttry {\n\t\t\t\t\tif (!(error instanceof Error)) {\n\t\t\t\t\t\tthrow new TypeError(`Non-error was thrown: \"${error}\". You should only throw errors.`)\n\t\t\t\t\t}\n\n\t\t\t\t\tif (error instanceof AbortError) {\n\t\t\t\t\t\tthrow error.originalError\n\t\t\t\t\t}\n\n\t\t\t\t\tdecorateErrorWithCounts(error, attemptNumber, options)\n\n\t\t\t\t\tif (options.shouldRetry && !(await options.shouldRetry(error))) {\n\t\t\t\t\t\toperation.stop()\n\t\t\t\t\t\treject(error)\n\t\t\t\t\t}\n\n\t\t\t\t\toptions.onFailedAttempt && (await options.onFailedAttempt(error))\n\n\t\t\t\t\tif (!operation.retry(error)) {\n\t\t\t\t\t\tthrow operation.mainError()\n\t\t\t\t\t}\n\t\t\t\t} catch (finalError) {\n\t\t\t\t\tdecorateErrorWithCounts(finalError as RetryError, attemptNumber, options)\n\t\t\t\t\tcleanUp()\n\t\t\t\t\treject(finalError)\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t})\n}\n\nexport default retry\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA,mBAA4C;AAIrC,MAAM,mBAAmB,MAAM;AAAA,EACrC;AAAA,EAEA,YAAY,SAAyB;AACpC,UAAM;AAEN,QAAI,mBAAmB,OAAO;AAC7B,WAAK,gBAAgB;AACpB,OAAC,EAAE,QAAQ,IAAI;AAAA,IACjB,OAAO;AACN,WAAK,gBAAgB,IAAI,MAAM,OAAO;AACtC,WAAK,cAAc,QAAQ,KAAK;AAAA,IACjC;AAEA,SAAK,OAAO;AACZ,SAAK,UAAU;AAAA,EAChB;AACD;AAYA,MAAM,0BAA0B,CAAC,OAAmB,eAAuB,YAAsC;AAEhH,QAAM,eAAe,QAAQ,WAAW,OAAO,gBAAgB;AAE/D,QAAM,gBAAgB;AACtB,QAAM,cAAc;AACpB,SAAO;AACR;AAEA,eAAsB,MAAS,OAA8C,SAAmC;AAC/G,SAAO,IAAI,QAAW,CAAC,SAAS,WAAW;AAC1C,cAAU,EAAE,GAAG,QAAQ;AACvB,YAAQ,oBAAoB,MAAM;AAAA,IAAC;AACnC,YAAQ,gBAAgB,MAAM;AAC9B,YAAQ,YAAY;AAEpB,UAAM,gBAA4B,aAAAA,WAAe,OAAO;AAExD,UAAM,UAAU,MAAM;AACrB,gBAAU,KAAK;AAAA,IAChB;AAEA,cAAU,QAAQ,OAAO,kBAA0B;AAClD,UAAI;AACH,cAAM,SAAS,MAAM,MAAM,aAAa;AACxC,gBAAQ;AACR,gBAAQ,MAAM;AAAA,MACf,SAAS,OAAO;AACf,YAAI;AACH,cAAI,EAAE,iBAAiB,QAAQ;AAC9B,kBAAM,IAAI,UAAU,0BAA0B,KAAK,kCAAkC;AAAA,UACtF;AAEA,cAAI,iBAAiB,YAAY;AAChC,kBAAM,MAAM;AAAA,UACb;AAEA,kCAAwB,OAAO,eAAe,OAAO;AAErD,cAAI,QAAQ,eAAe,CAAE,MAAM,QAAQ,YAAY,KAAK,GAAI;AAC/D,sBAAU,KAAK;AACf,mBAAO,KAAK;AAAA,UACb;AAEA,kBAAQ,mBAAoB,MAAM,QAAQ,gBAAgB,KAAK;AAE/D,cAAI,CAAC,UAAU,MAAM,KAAK,GAAG;AAC5B,kBAAM,UAAU,UAAU;AAAA,UAC3B;AAAA,QACD,SAAS,YAAY;AACpB,kCAAwB,YAA0B,eAAe,OAAO;AACxE,kBAAQ;AACR,iBAAO,UAAU;AAAA,QAClB;AAAA,MACD;AAAA,IACD,CAAC;AAAA,EACF,CAAC;AACF;AAEA,IAAO,gBAAQ;","names":["retryOperation"]}