{"version":3,"sources":["../../../src/utils/miscellaneous/jsonl.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { VError } from \"verror\"\n\n/**\n * Decode a jsonl stream into an array of objects.\n */\nexport async function jsonlDecodeStream<T = any>(stream: ReadableStream<Uint8Array>): Promise<T[]> {\n\t// or use `await new Response(stream).text()` and jsonl.parse(string) instead.\n\treturn Array.fromAsync(jsonlDecodeStreamAsync(stream))\n}\n\n/**\n * Asynchronously decode a jsonl stream into an array of objects.\n */\nexport async function* jsonlDecodeStreamAsync<T = any>(\n\tstream: ReadableStream,\n\toptions?: {\n\t\tskipInvalidLine?: boolean\n\t},\n): AsyncIterableIterator<T> {\n\tconst reader = stream.pipeThrough(new TextDecoderStream())\n\tlet memory = \"\"\n\tlet currentLine = 0\n\tfor await (const chunk of reader) {\n\t\tmemory += chunk\n\t\tconst lines = memory.split(\"\\n\")\n\t\tmemory = lines.pop() ?? \"\" // Keep the last line (might be incomplete)\n\n\t\tfor (const line of lines) {\n\t\t\tif (line.trim() === \"\") continue\n\n\t\t\ttry {\n\t\t\t\tconst parsed = JSON.parse(line) as T\n\t\t\t\tyield parsed\n\t\t\t} catch (error) {\n\t\t\t\tif (options?.skipInvalidLine) continue\n\t\t\t\tthrow new VError(error as Error, `Failed to parse JSONL line[${currentLine}]`)\n\t\t\t} finally {\n\t\t\t\tcurrentLine++\n\t\t\t}\n\t\t}\n\t}\n\tif (memory.trim() !== \"\") {\n\t\ttry {\n\t\t\tconst parsed = JSON.parse(memory) as T\n\t\t\tyield parsed\n\t\t} catch (error) {\n\t\t\tif (options?.skipInvalidLine) return\n\t\t\tthrow new VError(error as Error, `Failed to parse final JSONL line[${currentLine}]`)\n\t\t}\n\t}\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,oBAAuB;AAKvB,eAAsB,kBAA2B,QAAkD;AAElG,SAAO,MAAM,UAAU,uBAAuB,MAAM,CAAC;AACtD;AAKA,gBAAuB,uBACtB,QACA,SAG2B;AAC3B,QAAM,SAAS,OAAO,YAAY,IAAI,kBAAkB,CAAC;AACzD,MAAI,SAAS;AACb,MAAI,cAAc;AAClB,mBAAiB,SAAS,QAAQ;AACjC,cAAU;AACV,UAAM,QAAQ,OAAO,MAAM,IAAI;AAC/B,aAAS,MAAM,IAAI,KAAK;AAExB,eAAW,QAAQ,OAAO;AACzB,UAAI,KAAK,KAAK,MAAM,GAAI;AAExB,UAAI;AACH,cAAM,SAAS,KAAK,MAAM,IAAI;AAC9B,cAAM;AAAA,MACP,SAAS,OAAO;AACf,YAAI,SAAS,gBAAiB;AAC9B,cAAM,IAAI,qBAAO,OAAgB,8BAA8B,WAAW,GAAG;AAAA,MAC9E,UAAE;AACD;AAAA,MACD;AAAA,IACD;AAAA,EACD;AACA,MAAI,OAAO,KAAK,MAAM,IAAI;AACzB,QAAI;AACH,YAAM,SAAS,KAAK,MAAM,MAAM;AAChC,YAAM;AAAA,IACP,SAAS,OAAO;AACf,UAAI,SAAS,gBAAiB;AAC9B,YAAM,IAAI,qBAAO,OAAgB,oCAAoC,WAAW,GAAG;AAAA,IACpF;AAAA,EACD;AACD;","names":[]}