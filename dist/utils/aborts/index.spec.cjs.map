{"version":3,"sources":["../../../src/utils/aborts/index.spec.ts"],"sourcesContent":["import { describe, expect, it, vi, beforeEach, afterEach } from \"vitest\"\n\nimport { Aborts } from \"./index\"\n\ndescribe(\"aborts\", () => {\n\tbeforeEach(() => {\n\t\tvi.useFakeTimers()\n\t})\n\n\tafterEach(() => {\n\t\tvi.useRealTimers()\n\t})\n\n\tdescribe(\"awaitAbort\", () => {\n\t\tit(\"should resolve when signal is aborted\", async () => {\n\t\t\tconst controller = new AbortController()\n\n\t\t\t// Trigger abort in future\n\t\t\tsetTimeout(() => controller.abort(), 100)\n\n\t\t\tconst promise = Aborts.awaitAbort(controller.signal)\n\n\t\t\t// Should not resolve yet\n\t\t\tconst resolved = vi.fn()\n\t\t\tpromise.then(resolved)\n\t\t\texpect(resolved).not.toHaveBeenCalled()\n\n\t\t\t// Advance time\n\t\t\tawait vi.advanceTimersByTimeAsync(100)\n\n\t\t\texpect(resolved).toHaveBeenCalled()\n\t\t})\n\n\t\tit(\"should resolve immediately if already aborted\", async () => {\n\t\t\tconst controller = new AbortController()\n\t\t\tcontroller.abort()\n\n\t\t\tconst promise = Aborts.awaitAbort(controller.signal)\n\t\t\tawait expect(promise).resolves.toBeUndefined()\n\t\t})\n\t})\n\n\tdescribe(\"awaitAbortWithReject\", () => {\n\t\tit(\"should reject when signal is aborted\", async () => {\n\t\t\tconst controller = new AbortController()\n\t\t\tsetTimeout(() => controller.abort(new Error(\"aborted\")), 100)\n\n\t\t\tconst promise = Aborts.awaitAbortWithReject(controller.signal)\n\n\t\t\t// Catch the rejection to prevent \"Unhandled Rejection\"\n\t\t\tconst catchFn = vi.fn()\n\t\t\tpromise.catch(catchFn)\n\n\t\t\t// Advance time\n\t\t\tawait vi.advanceTimersByTimeAsync(100)\n\n\t\t\tawait expect(promise).rejects.toThrow(\"aborted\")\n\t\t})\n\n\t\tit(\"should reject immediately if already aborted\", async () => {\n\t\t\tconst controller = new AbortController()\n\t\t\tcontroller.abort(new Error(\"aborted\"))\n\n\t\t\tawait expect(Aborts.awaitAbortWithReject(controller.signal)).rejects.toThrow(\"aborted\")\n\t\t})\n\t})\n\n\tdescribe(\"awaitAbortOrTimeout\", () => {\n\t\tit(\"should return timeout if time passes first\", async () => {\n\t\t\tconst controller = new AbortController()\n\t\t\tconst promise = Aborts.awaitAbortOrTimeout(controller.signal, 100)\n\n\t\t\tawait vi.advanceTimersByTimeAsync(100)\n\n\t\t\tawait expect(promise).resolves.toBe(\"timeout\")\n\t\t})\n\n\t\tit(\"should return aborted if signal aborts first\", async () => {\n\t\t\tconst controller = new AbortController()\n\t\t\tsetTimeout(() => controller.abort(), 50)\n\n\t\t\tconst promise = Aborts.awaitAbortOrTimeout(controller.signal, 100)\n\n\t\t\tawait vi.advanceTimersByTimeAsync(50)\n\n\t\t\tawait expect(promise).resolves.toBe(\"aborted\")\n\t\t})\n\t})\n\n\tdescribe(\"raceWithAbort\", () => {\n\t\tit(\"should return fulfilled status with value\", async () => {\n\t\t\tconst controller = new AbortController()\n\t\t\tconst result = await Aborts.raceWithAbort(controller.signal, async () => \"success\")\n\n\t\t\texpect(result).toEqual({ status: \"fulfilled\", value: \"success\" })\n\t\t})\n\n\t\tit(\"should return aborted status with reason\", async () => {\n\t\t\tconst controller = new AbortController()\n\n\t\t\t// Abort after 10ms\n\t\t\tsetTimeout(() => controller.abort(), 10)\n\n\t\t\tconst promise = Aborts.raceWithAbort(controller.signal, async () => {\n\t\t\t\t// Task that takes longer than abort\n\t\t\t\tawait new Promise((resolve) => setTimeout(resolve, 50))\n\t\t\t\treturn \"should not reach here\"\n\t\t\t})\n\n\t\t\t// Advance past abort time but before task completion\n\t\t\tawait vi.advanceTimersByTimeAsync(10)\n\n\t\t\tconst result = await promise\n\t\t\texpect(result.status).toBe(\"aborted\")\n\t\t\texpect(result.reason).toBeInstanceOf(DOMException)\n\t\t\texpect((result.reason as DOMException).name).toBe(\"AbortError\")\n\t\t})\n\n\t\tit(\"should throw non-abort errors\", async () => {\n\t\t\tconst controller = new AbortController()\n\n\t\t\tawait expect(\n\t\t\t\tAborts.raceWithAbort(controller.signal, async () => {\n\t\t\t\t\tthrow new Error(\"fail\")\n\t\t\t\t}),\n\t\t\t).rejects.toThrow(\"fail\")\n\t\t})\n\t})\n\n\tdescribe(\"withAbortSignal\", () => {\n\t\tit(\"should reject with abort reason if aborted during execution\", async () => {\n\t\t\tconst controller = new AbortController()\n\n\t\t\tsetTimeout(() => controller.abort(new Error(\"cancelled\")), 10)\n\n\t\t\tconst promise = Aborts.withAbortSignal(controller.signal, async () => {\n\t\t\t\tawait new Promise((resolve) => setTimeout(resolve, 50))\n\t\t\t})\n\n\t\t\t// Catch the rejection to prevent \"Unhandled Rejection\"\n\t\t\tconst catchFn = vi.fn()\n\t\t\tpromise.catch(catchFn)\n\n\t\t\tawait vi.advanceTimersByTimeAsync(10)\n\n\t\t\tawait expect(promise).rejects.toThrow(\"cancelled\")\n\t\t})\n\t})\n\n\tdescribe(\"raceAllWithAbort\", () => {\n\t\tit(\"should resolve with first completed promise\", async () => {\n\t\t\tconst controller = new AbortController()\n\n\t\t\tconst promise = Aborts.raceAllWithAbort(controller.signal, [\n\t\t\t\tasync () => {\n\t\t\t\t\tawait new Promise((r) => setTimeout(r, 50))\n\t\t\t\t\treturn 1\n\t\t\t\t},\n\t\t\t\tasync () => {\n\t\t\t\t\tawait new Promise((r) => setTimeout(r, 10))\n\t\t\t\t\treturn 2\n\t\t\t\t},\n\t\t\t])\n\n\t\t\tawait vi.advanceTimersByTimeAsync(10)\n\n\t\t\tawait expect(promise).resolves.toBe(2)\n\t\t})\n\t})\n})\n"],"mappings":"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","names":[]}