{"version":3,"sources":["/home/runner/work/ts-utilities/ts-utilities/dist/chunk-AIZOMPYG.cjs","../src/kms/client.ts"],"names":["hash"],"mappings":"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","file":"/home/runner/work/ts-utilities/ts-utilities/dist/chunk-AIZOMPYG.cjs","sourcesContent":[null,"import crypto from \"node:crypto\"\n\nimport { KeyManagementServiceClient } from \"@google-cloud/kms\"\nimport { VError } from \"verror\"\n\nimport type { EncryptionResult, KMSClientConfig, KMSClientInterface } from \"./interfaces\"\n\n/**\n * Google Cloud KMS client for encryption and decryption operations\n */\nexport class KMSClient implements KMSClientInterface {\n\tprivate readonly client: KeyManagementServiceClient\n\tprivate readonly keyName: string\n\treadonly #pubkeys = new Map<string, { pem: string; hash: \"sha1\" | \"sha256\" | \"sha512\" }>()\n\n\tconstructor(private readonly config: KMSClientConfig) {\n\t\tthis.client = new KeyManagementServiceClient()\n\t\tthis.keyName = this.client.cryptoKeyPath(\n\t\t\tthis.config.project,\n\t\t\tthis.config.location,\n\t\t\tthis.config.keyRing,\n\t\t\tthis.config.key,\n\t\t)\n\t}\n\n\t/**\n\t * Encrypts plaintext using Google Cloud KMS.\n\t * Ref: https://docs.cloud.google.com/kms/docs/encrypt-decrypt#kms-encrypt-symmetric-nodejs\n\t *\n\t * The encrypt() method automatically detects key type (CryptoKey or CryptoKeyVersion) and uses the appropriate method for encryption\n\t * - `CryptoKey`: Symmetric encryption with the primary key version\n\t * - `CryptoKeyVersion`: Asymmetric encryption with public key of the specified version\n\t */\n\tasync encrypt(plaintext: string, cryptoKeyVersion?: string): Promise<EncryptionResult> {\n\t\ttry {\n\t\t\tif (this.config.keyBased === \"asymmetric\") {\n\t\t\t\tif (!cryptoKeyVersion) {\n\t\t\t\t\tthrow new VError(\"Crypto key version is required for asymmetric encryption\")\n\t\t\t\t}\n\t\t\t\treturn await this.encryptAsymmetric(plaintext, cryptoKeyVersion)\n\t\t\t}\n\n\t\t\tconst [encryptResponse] = await this.client.encrypt({\n\t\t\t\tname: this.keyName,\n\t\t\t\tplaintext: Buffer.from(plaintext),\n\t\t\t})\n\n\t\t\tif (!encryptResponse?.ciphertext || !encryptResponse.name) {\n\t\t\t\tthrow new VError(\"Not all required fields returned from KMS\")\n\t\t\t}\n\n\t\t\t// Extract crypto key version from the response name\n\t\t\tconst nameparts = encryptResponse.name.split(\"/\")\n\t\t\tconst version = nameparts[nameparts.length - 1]\n\n\t\t\tif (!version) {\n\t\t\t\tthrow new VError(\"No crypto key version returned from KMS\")\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tciphertext: Buffer.from(encryptResponse.ciphertext).toString(\"base64\"),\n\t\t\t\tcryptoKeyVersion: version,\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tif (error instanceof VError) throw error\n\t\t\tthrow new VError(error as Error, \"Failed to encrypt with KMS\")\n\t\t}\n\t}\n\n\t/**\n\t * Encrypts plaintext using Google Cloud KMS with asymmetric key (public key).\n\t * Ref: https://docs.cloud.google.com/kms/docs/encrypt-decrypt-rsa#kms-encrypt-asymmetric-nodejs\n\t */\n\tasync encryptAsymmetric(plaintext: string, cryptoKeyVersion: string): Promise<EncryptionResult> {\n\t\ttry {\n\t\t\tconst keyVersionName = this.client.cryptoKeyVersionPath(\n\t\t\t\tthis.config.project,\n\t\t\t\tthis.config.location,\n\t\t\t\tthis.config.keyRing,\n\t\t\t\tthis.config.key,\n\t\t\t\tcryptoKeyVersion,\n\t\t\t)\n\n\t\t\tif (!this.#pubkeys.has(keyVersionName)) {\n\t\t\t\tconst [publicKey] = await this.client.getPublicKey({ name: keyVersionName })\n\t\t\t\tif (!publicKey.pem) {\n\t\t\t\t\tthrow new VError(\"Public key PEM not found from KMS\")\n\t\t\t\t}\n\t\t\t\t// Map KMS algorithm to Node.js crypto parameters\n\t\t\t\tconst algorithm = publicKey.algorithm?.toString().toLowerCase() || \"\"\n\t\t\t\tconst hash = algorithm.includes(\"sha256\")\n\t\t\t\t\t? \"sha256\"\n\t\t\t\t\t: algorithm.includes(\"sha512\")\n\t\t\t\t\t\t? \"sha512\"\n\t\t\t\t\t\t: algorithm.includes(\"sha1\")\n\t\t\t\t\t\t\t? \"sha1\"\n\t\t\t\t\t\t\t: \"sha256\"\n\t\t\t\tthis.#pubkeys.set(keyVersionName, { pem: publicKey.pem, hash: hash })\n\t\t\t}\n\n\t\t\tconst { pem, hash } = this.#pubkeys.get(keyVersionName)!\n\t\t\tconst ciphertext = crypto.publicEncrypt(\n\t\t\t\t{\n\t\t\t\t\tkey: pem,\n\t\t\t\t\tpadding: crypto.constants.RSA_PKCS1_OAEP_PADDING,\n\t\t\t\t\toaepHash: hash,\n\t\t\t\t},\n\t\t\t\tBuffer.from(plaintext),\n\t\t\t)\n\n\t\t\treturn {\n\t\t\t\tciphertext: ciphertext.toString(\"base64\"),\n\t\t\t\tcryptoKeyVersion,\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthrow new VError(error as Error, \"Failed to encrypt asymmetrically with KMS\")\n\t\t}\n\t}\n\n\t/**\n\t * Decrypts ciphertext using Google Cloud KMS\n\t * Ref: https://docs.cloud.google.com/kms/docs/encrypt-decrypt#kms-decrypt-symmetric-nodejs\n\t *\n\t * The decrypt() method automatically detects key type (CryptoKey or CryptoKeyVersion) and uses the appropriate method for decryption\n\t * - `CryptoKey`: Symmetric decryption with the primary key version\n\t * - `CryptoKeyVersion`: Asymmetric decryption with public key of the specified version\n\t */\n\tasync decrypt(ciphertext: string, cryptoKeyVersion?: string): Promise<string> {\n\t\ttry {\n\t\t\tif (this.config.keyBased === \"asymmetric\") {\n\t\t\t\tif (!cryptoKeyVersion) {\n\t\t\t\t\tthrow new VError(\"Crypto key version is required for asymmetric decryption\")\n\t\t\t\t}\n\t\t\t\treturn await this.decryptAsymmetric(ciphertext, cryptoKeyVersion)\n\t\t\t}\n\n\t\t\tconst ciphertextBuffer = Buffer.from(ciphertext, \"base64\")\n\t\t\tconst [decryptResponse] = await this.client.decrypt({\n\t\t\t\tname: this.keyName,\n\t\t\t\tciphertext: ciphertextBuffer,\n\t\t\t})\n\n\t\t\tif (!decryptResponse.plaintext) {\n\t\t\t\tthrow new VError(\"No plaintext returned from KMS\")\n\t\t\t}\n\n\t\t\treturn Buffer.from(decryptResponse.plaintext).toString()\n\t\t} catch (error) {\n\t\t\tthrow new VError(error as Error, \"Failed to decrypt with KMS\")\n\t\t}\n\t}\n\n\t/**\n\t * Decrypts ciphertext using Google Cloud KMS with asymmetric key\n\t * Note: Asymmetric decryption requires specifying the exact key version used for encryption\n\t * Ref: https://docs.cloud.google.com/kms/docs/encrypt-decrypt-rsa#kms-decrypt-asymmetric-nodejs\n\t */\n\tasync decryptAsymmetric(ciphertext: string, cryptoKeyVersion: string): Promise<string> {\n\t\ttry {\n\t\t\tconst ciphertextBuffer = Buffer.from(ciphertext, \"base64\")\n\n\t\t\tconst keyName = this.client.cryptoKeyVersionPath(\n\t\t\t\tthis.config.project,\n\t\t\t\tthis.config.location,\n\t\t\t\tthis.config.keyRing,\n\t\t\t\tthis.config.key,\n\t\t\t\tcryptoKeyVersion,\n\t\t\t)\n\n\t\t\tconst [decryptResponse] = await this.client.asymmetricDecrypt({\n\t\t\t\tname: keyName,\n\t\t\t\tciphertext: ciphertextBuffer,\n\t\t\t})\n\n\t\t\tif (!decryptResponse.plaintext) {\n\t\t\t\tthrow new VError(\"No plaintext returned from KMS\")\n\t\t\t}\n\n\t\t\treturn Buffer.from(decryptResponse.plaintext).toString()\n\t\t} catch (error) {\n\t\t\tthrow new VError(error as Error, \"Failed to decrypt asymmetrically with KMS\")\n\t\t}\n\t}\n\n\t/**\n\t * Closes the KMS client connection\n\t */\n\tasync close(): Promise<void> {\n\t\tawait this.client.close()\n\t}\n}\n"]}