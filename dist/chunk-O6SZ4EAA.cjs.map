{"version":3,"sources":["/home/runner/work/ts-utilities/ts-utilities/dist/chunk-O6SZ4EAA.cjs","../src/kms/client.ts"],"names":[],"mappings":"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","file":"/home/runner/work/ts-utilities/ts-utilities/dist/chunk-O6SZ4EAA.cjs","sourcesContent":[null,"import { KeyManagementServiceClient } from \"@google-cloud/kms\"\nimport { VError } from \"verror\"\n\nimport type { EncryptionResult, KMSClientConfig, KMSClientInterface } from \"./interfaces\"\n\n/**\n * Google Cloud KMS client for encryption and decryption operations\n */\nexport class KMSClient implements KMSClientInterface {\n\tprivate readonly client: KeyManagementServiceClient\n\tprivate readonly keyName: string\n\n\tconstructor(private readonly config: KMSClientConfig) {\n\t\tthis.client = new KeyManagementServiceClient()\n\t\tthis.keyName = this.client.cryptoKeyPath(\n\t\t\tthis.config.project,\n\t\t\tthis.config.location,\n\t\t\tthis.config.keyRing,\n\t\t\tthis.config.key,\n\t\t)\n\t}\n\n\t/**\n\t * Encrypts plaintext using Google Cloud KMS.\n\t *\n\t * The encrypt() method automatically detects key type (CryptoKey or CryptoKeyVersion) and uses the appropriate method for encryption\n\t * - `CryptoKey`: Symmetric encryption with the primary key version\n\t * - `CryptoKeyVersion`: Asymmetric encryption with public key of the specified version\n\t */\n\tasync encrypt(plaintext: string, cryptoKeyVersion?: string): Promise<EncryptionResult> {\n\t\ttry {\n\t\t\tconst keyName = cryptoKeyVersion\n\t\t\t\t? this.client.cryptoKeyVersionPath(\n\t\t\t\t\t\tthis.config.project,\n\t\t\t\t\t\tthis.config.location,\n\t\t\t\t\t\tthis.config.keyRing,\n\t\t\t\t\t\tthis.config.key,\n\t\t\t\t\t\tcryptoKeyVersion,\n\t\t\t\t\t)\n\t\t\t\t: this.keyName\n\n\t\t\tconst [encryptResponse] = await this.client.encrypt({\n\t\t\t\tname: keyName,\n\t\t\t\tplaintext: Buffer.from(plaintext),\n\t\t\t})\n\n\t\t\tif (!encryptResponse?.ciphertext || !encryptResponse.name) {\n\t\t\t\tthrow new VError(\"Not all required fields returned from KMS\")\n\t\t\t}\n\n\t\t\t// Extract crypto key version from the response name\n\t\t\tconst nameparts = encryptResponse.name.split(\"/\")\n\t\t\tcryptoKeyVersion = nameparts[nameparts.length - 1]\n\n\t\t\tif (!cryptoKeyVersion) {\n\t\t\t\tthrow new VError(\"No crypto key version returned from KMS\")\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tciphertext: Buffer.from(encryptResponse.ciphertext).toString(\"base64\"),\n\t\t\t\tcryptoKeyVersion,\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthrow new VError(error as Error, \"Failed to encrypt with KMS\")\n\t\t}\n\t}\n\n\t/**\n\t * Decrypts ciphertext using Google Cloud KMS\n\t */\n\tasync decrypt(ciphertext: string): Promise<string> {\n\t\ttry {\n\t\t\tconst ciphertextBuffer = Buffer.from(ciphertext, \"base64\")\n\t\t\tconst [decryptResponse] = await this.client.decrypt({\n\t\t\t\tname: this.keyName,\n\t\t\t\tciphertext: ciphertextBuffer,\n\t\t\t})\n\n\t\t\tif (!decryptResponse.plaintext) {\n\t\t\t\tthrow new VError(\"No plaintext returned from KMS\")\n\t\t\t}\n\n\t\t\treturn Buffer.from(decryptResponse.plaintext).toString()\n\t\t} catch (error) {\n\t\t\tthrow new VError(error as Error, \"Failed to decrypt with KMS\")\n\t\t}\n\t}\n\n\t/**\n\t * Decrypts ciphertext using Google Cloud KMS with asymmetric key\n\t * Note: Asymmetric decryption requires specifying the exact key version used for encryption\n\t */\n\tasync decryptAsymmetric(ciphertext: string, cryptoKeyVersion: string): Promise<string> {\n\t\ttry {\n\t\t\tconst ciphertextBuffer = Buffer.from(ciphertext, \"base64\")\n\n\t\t\tconst keyName = this.client.cryptoKeyVersionPath(\n\t\t\t\tthis.config.project,\n\t\t\t\tthis.config.location,\n\t\t\t\tthis.config.keyRing,\n\t\t\t\tthis.config.key,\n\t\t\t\tcryptoKeyVersion,\n\t\t\t)\n\n\t\t\tconst [decryptResponse] = await this.client.asymmetricDecrypt({\n\t\t\t\tname: keyName,\n\t\t\t\tciphertext: ciphertextBuffer,\n\t\t\t})\n\n\t\t\tif (!decryptResponse.plaintext) {\n\t\t\t\tthrow new VError(\"No plaintext returned from KMS\")\n\t\t\t}\n\n\t\t\treturn Buffer.from(decryptResponse.plaintext).toString()\n\t\t} catch (error) {\n\t\t\tthrow new VError(error as Error, \"Failed to decrypt asymmetrically with KMS\")\n\t\t}\n\t}\n\n\t/**\n\t * Closes the KMS client connection\n\t */\n\tasync close(): Promise<void> {\n\t\tawait this.client.close()\n\t}\n}\n"]}