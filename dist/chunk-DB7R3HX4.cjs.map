{"version":3,"sources":["/home/runner/work/ts-utilities/ts-utilities/dist/chunk-DB7R3HX4.cjs","../src/storage/cloud-storage.ts"],"names":[],"mappings":"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","file":"/home/runner/work/ts-utilities/ts-utilities/dist/chunk-DB7R3HX4.cjs","sourcesContent":[null,"import { pipeline } from \"node:stream/promises\"\n\nimport { SaveData, Storage } from \"@google-cloud/storage\"\n\nimport { PrimitiveValue } from \"@/types\"\n\nimport { NotFoundError, ForbiddenError, SomethingWentWrong, BadRequestError } from \"../errors/errors\"\n\ntype FileUriInfo = {\n\tbucketName: string\n\tfilePath: string\n}\n\n// GCS Error interface\ninterface CloudStorageError extends Error {\n\tcode?: number\n}\n\n// Type guard for GCS errors\nfunction isGCSError(error: unknown): error is CloudStorageError {\n\treturn error != null && typeof error === \"object\" && \"code\" in error && typeof error.code === \"number\"\n}\n\nexport interface UploadOptions {\n\tcontentType?: string\n\tmetadata?: Record<string, PrimitiveValue>\n}\n\nexport interface UploadResult {\n\turi: string\n\tfileSize: number\n\tchecksumCrc32c: string | undefined\n\tchecksumMd5: string | undefined\n\tcontentType: string\n\tbucketName: string\n\tfilePath: string\n}\n\n/**\n * GCS Helper class for file operations\n */\nexport class CloudStorageService {\n\tconstructor(public readonly storage: Storage) {}\n\n\tasync getFileMetadata(fileUrl: string) {\n\t\ttry {\n\t\t\tconst info = CloudStorageService.extractInfo(fileUrl)\n\t\t\tif (!info) {\n\t\t\t\treturn null\n\t\t\t}\n\n\t\t\t// Get file metadata from GCS\n\t\t\t// https://cloud.google.com/storage/docs/samples/storage-get-metadata\n\t\t\tconst file = this.storage.bucket(info.bucketName).file(info.filePath)\n\t\t\tconst [fileExists] = await file.exists()\n\t\t\tif (!fileExists) {\n\t\t\t\treturn null\n\t\t\t}\n\t\t\tconst [metadata] = await file.getMetadata()\n\t\t\tif (!metadata.timeCreated) {\n\t\t\t\treturn null\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tbucketName: info.bucketName,\n\t\t\t\tfilePath: info.filePath,\n\t\t\t\tname: (metadata.name ?? info.filePath).split(\"/\").pop() ?? \"\",\n\t\t\t\tcontentType: metadata.contentType ?? \"application/octet-stream\",\n\t\t\t\tsize: Number(metadata.size ?? 0),\n\t\t\t\tchecksumCrc32c: metadata.crc32c,\n\t\t\t\tchecksumMd5: metadata.md5Hash,\n\t\t\t\tcreatedAt: new Date(metadata.timeCreated ?? 0),\n\t\t\t\tmodifiedAt: new Date(metadata.updated ?? 0),\n\t\t\t\twebUrl: metadata.mediaLink,\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tif (isGCSError(error)) {\n\t\t\t\tif (error.code === 404 || (error instanceof Error && error.message?.toLowerCase().includes(\"not found\"))) {\n\t\t\t\t\treturn null\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new SomethingWentWrong(`Failed to get file info: ${fileUrl}`, {\n\t\t\t\tcause: error,\n\t\t\t})\n\t\t}\n\t}\n\n\tasync download(fileUrl: string): Promise<Buffer> {\n\t\t// Check if it's a Google Cloud Storage URL\n\t\tconst info = CloudStorageService.extractInfo(fileUrl)\n\n\t\tif (info) {\n\t\t\t// Download from Cloud Storage\n\t\t\tconst bucket = this.storage.bucket(info.bucketName)\n\t\t\tconst file = bucket.file(info.filePath)\n\n\t\t\ttry {\n\t\t\t\tconst [content] = await file.download()\n\t\t\t\treturn content\n\t\t\t} catch (error: unknown) {\n\t\t\t\tif (isGCSError(error)) {\n\t\t\t\t\tif (error.code === 404 || (error instanceof Error && error.message?.toLowerCase().includes(\"not found\"))) {\n\t\t\t\t\t\tthrow new NotFoundError(`File not found in storage: gs://${info.bucketName}/${info.filePath}`, {\n\t\t\t\t\t\t\tcause: error,\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t\tif (error.code === 403) {\n\t\t\t\t\t\tthrow new ForbiddenError(`Access denied to file: gs://${info.bucketName}/${info.filePath}`, {\n\t\t\t\t\t\t\tcause: error,\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tthrow new SomethingWentWrong(`Failed to download from GCS: gs://${info.bucketName}/${info.filePath}`, {\n\t\t\t\t\tcause: error,\n\t\t\t\t})\n\t\t\t}\n\t\t} else {\n\t\t\t// Download directly via HTTP\n\t\t\tconst response = await fetch(fileUrl)\n\t\t\tif (!response.ok) {\n\t\t\t\tif (response.status === 404) {\n\t\t\t\t\tthrow new NotFoundError(`File not found: ${fileUrl}`)\n\t\t\t\t}\n\t\t\t\tif (response.status >= 400 && response.status < 500) {\n\t\t\t\t\tthrow new BadRequestError(\n\t\t\t\t\t\t`Failed to fetch file from ${fileUrl}: Got status code ${response.status} ${response.statusText}`,\n\t\t\t\t\t)\n\t\t\t\t}\n\t\t\t\tthrow new SomethingWentWrong(\n\t\t\t\t\t`Failed to fetch file from ${fileUrl}: Got status code ${response.status} ${response.statusText}`,\n\t\t\t\t)\n\t\t\t}\n\t\t\tconst arrayBuffer = await response.arrayBuffer()\n\t\t\treturn Buffer.from(arrayBuffer)\n\t\t}\n\t}\n\n\t/**\n\t * Upload new file to GCS\n\t */\n\tasync upload(\n\t\tbucketName: string,\n\t\tfilePath: string,\n\t\tcontent: SaveData,\n\t\toptions?: UploadOptions,\n\t): Promise<UploadResult> {\n\t\tconst file = this.storage.bucket(bucketName).file(filePath)\n\t\ttry {\n\t\t\tawait file.save(content, options)\n\t\t} catch (error) {\n\t\t\tthrow new SomethingWentWrong(`Failed to upload file to gs://${bucketName}/${filePath}`, {\n\t\t\t\tcause: error,\n\t\t\t})\n\t\t}\n\t\tconst [metadata] = await file.getMetadata()\n\t\treturn {\n\t\t\turi: file.cloudStorageURI.href,\n\t\t\tfileSize: Number(metadata.size ?? 0),\n\t\t\tchecksumCrc32c: metadata.crc32c,\n\t\t\tchecksumMd5: metadata.md5Hash,\n\t\t\tcontentType: metadata.contentType ?? options?.contentType ?? \"application/octet-stream\",\n\t\t\tbucketName,\n\t\t\tfilePath,\n\t\t}\n\t}\n\n\t/**\n\t * Upload new file to GCS from the given file URL\n\t */\n\tasync uploadFromUrl(\n\t\tbucketName: string,\n\t\tfilePath: string,\n\t\tfileDownloadUrl: string,\n\t\toptions?: UploadOptions,\n\t): Promise<UploadResult> {\n\t\tconst response = await fetch(fileDownloadUrl)\n\t\tif (!response.ok) {\n\t\t\tif (response.status === 404) {\n\t\t\t\tthrow new NotFoundError(`File not found: ${fileDownloadUrl}`)\n\t\t\t}\n\t\t\tif (response.status >= 400 && response.status < 500) {\n\t\t\t\tthrow new BadRequestError(\n\t\t\t\t\t`Failed to fetch file from ${fileDownloadUrl}: Got status code ${response.status} ${response.statusText}`,\n\t\t\t\t)\n\t\t\t}\n\t\t\tthrow new BadRequestError(\n\t\t\t\t`Failed to fetch file from ${fileDownloadUrl}: ${response.status} ${response.statusText}`,\n\t\t\t)\n\t\t}\n\t\tconst file = this.storage.bucket(bucketName).file(filePath)\n\n\t\tconst stream = response.body\n\t\tif (!stream) {\n\t\t\tthrow new SomethingWentWrong(`Failed to get stream from ${fileDownloadUrl}`, {\n\t\t\t\tcause: new Error(`Failed to get stream from ${fileDownloadUrl}`),\n\t\t\t})\n\t\t}\n\t\ttry {\n\t\t\tawait pipeline(\n\t\t\t\tstream,\n\t\t\t\tfile.createWriteStream({\n\t\t\t\t\t...options,\n\t\t\t\t\tresumable: false,\n\t\t\t\t\tcontentType: response.headers.get(\"content-type\") ?? options?.contentType ?? undefined,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t...options?.metadata,\n\t\t\t\t\t\tsrc_url: fileDownloadUrl,\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t)\n\n\t\t\tconst [metadata] = await file.getMetadata()\n\t\t\treturn {\n\t\t\t\turi: file.cloudStorageURI.href,\n\t\t\t\tfileSize: Number(metadata.size ?? 0),\n\t\t\t\tchecksumCrc32c: metadata.crc32c,\n\t\t\t\tchecksumMd5: metadata.md5Hash,\n\t\t\t\tcontentType:\n\t\t\t\t\tmetadata.contentType ??\n\t\t\t\t\tresponse.headers.get(\"content-type\") ??\n\t\t\t\t\toptions?.contentType ??\n\t\t\t\t\t\"application/octet-stream\",\n\t\t\t\tbucketName,\n\t\t\t\tfilePath,\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthrow new SomethingWentWrong(`Failed to upload file to gs://${bucketName}/${filePath}`, {\n\t\t\t\tcause: error,\n\t\t\t})\n\t\t}\n\t}\n\n\tasync getSignedUrl(fileUrl: string, ttl: number = 1000 * 60 * 60 * 1) {\n\t\t// Determine bucket name and the bucket base URL from either subdomain or path-style URL\n\t\tconst info = CloudStorageService.extractInfo(fileUrl)\n\t\tif (!info) {\n\t\t\treturn fileUrl\n\t\t}\n\n\t\ttry {\n\t\t\t// Get file reference from GCS bucket\n\t\t\tconst bucket = this.storage.bucket(info.bucketName)\n\t\t\tconst file = bucket.file(info.filePath)\n\n\t\t\tconst now = new Date()\n\n\t\t\t// Generate signed URL\n\t\t\tconst [signedUrl] = await file.getSignedUrl({\n\t\t\t\taction: \"read\",\n\t\t\t\taccessibleAt: now,\n\t\t\t\texpires: new Date(now.getTime() + ttl),\n\t\t\t})\n\n\t\t\t// Replace the canonical https://storage.googleapis.com/<bucket> with the subdomain public URL\n\t\t\treturn signedUrl.replace(\n\t\t\t\t`https://storage.googleapis.com/${info.bucketName}`,\n\t\t\t\tCloudStorageService.basePublicUrl(info),\n\t\t\t)\n\t\t} catch (error: unknown) {\n\t\t\tif (isGCSError(error)) {\n\t\t\t\tif (error.code === 404 || (error instanceof Error && error.message?.toLowerCase().includes(\"not found\"))) {\n\t\t\t\t\tthrow new NotFoundError(`File not found for signed URL generation: gs://${info.bucketName}/${info.filePath}`)\n\t\t\t\t}\n\t\t\t\tif (error.code === 403) {\n\t\t\t\t\tthrow new ForbiddenError(`Access denied to generate signed URL for: gs://${info.bucketName}/${info.filePath}`)\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new SomethingWentWrong(`Failed to generate signed URL for file: ${fileUrl}`, {\n\t\t\t\tcause: error,\n\t\t\t})\n\t\t}\n\t}\n\n\tasync checkResourceType(resourceUrl: string): Promise<\"file\" | \"folder\" | null> {\n\t\tconst info = CloudStorageService.extractInfo(resourceUrl)\n\t\tif (!info) {\n\t\t\treturn null\n\t\t}\n\t\ttry {\n\t\t\tconst bucket = this.storage.bucket(info.bucketName)\n\t\t\tconst file = bucket.file(info.filePath)\n\t\t\tconst [fileExists] = await file.exists()\n\t\t\tif (fileExists) {\n\t\t\t\treturn \"file\"\n\t\t\t}\n\n\t\t\t// Check if folder by listing files with prefix\n\t\t\tconst [files] = await bucket.getFiles({\n\t\t\t\tprefix: resourceUrl.endsWith(\"/\") ? resourceUrl : resourceUrl + \"/\",\n\t\t\t\tmaxResults: 1,\n\t\t\t})\n\t\t\tif (files.length > 0) {\n\t\t\t\treturn \"folder\"\n\t\t\t}\n\t\t\treturn null\n\t\t} catch (error) {\n\t\t\tif (isGCSError(error)) {\n\t\t\t\tif (error.code === 404 || (error instanceof Error && error.message?.toLowerCase().includes(\"not found\"))) {\n\t\t\t\t\tthrow new NotFoundError(`File not found for signed URL generation: gs://${info.bucketName}/${info.filePath}`)\n\t\t\t\t}\n\t\t\t\tif (error.code === 403) {\n\t\t\t\t\tthrow new ForbiddenError(`Access denied to generate signed URL for: gs://${info.bucketName}/${info.filePath}`)\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new SomethingWentWrong(`Failed to check item type: ${resourceUrl}`, {\n\t\t\t\tcause: error,\n\t\t\t})\n\t\t}\n\t}\n\n\t/**\n\t * Check if a URL is a GCS URL\n\t * @param fileUrl - The URL of the file.\n\t * @returns True if the URL is a GCS URL, false otherwise.\n\t */\n\tstatic isGCSUrl(fileUrl: string): boolean {\n\t\tif (fileUrl.startsWith(\"gs://\")) {\n\t\t\treturn true\n\t\t}\n\t\tconst url = new URL(fileUrl)\n\t\treturn url.hostname.endsWith(\".storage.googleapis.com\") || url.hostname === \"storage.googleapis.com\"\n\t}\n\n\t/**\n\t * Extract GCS File info from a URL\n\t * @param baseMediaUrl - The URL of the file.\n\t * e.g.\n\t *   - `gs://{bucketName}/{objectPath}`\n\t *   - `https://{bucketName}.storage.googleapis.com/{objectPath}`\n\t *   - `https://storage.googleapis.com/{bucketName}/{objectPath}`\n\t */\n\tstatic extractInfo(baseMediaUrl: string): FileUriInfo | null {\n\t\tconst url = new URL(baseMediaUrl)\n\t\tlet bucketName: string | null = null\n\t\tlet objectPath = \"\"\n\n\t\t// Handle gs:// format\n\t\tif (baseMediaUrl.startsWith(\"gs://\")) {\n\t\t\tconst [, path] = baseMediaUrl.split(\"gs://\")\n\t\t\tif (!path) {\n\t\t\t\treturn null\n\t\t\t}\n\t\t\tconst [bucket, ...objectParts] = path.split(\"/\")\n\t\t\tif (!bucket) {\n\t\t\t\treturn null\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tbucketName: bucket,\n\t\t\t\tfilePath: objectParts.join(\"/\"),\n\t\t\t}\n\t\t}\n\n\t\t// Handle public URL format\n\t\tif (url.hostname.endsWith(\".storage.googleapis.com\")) {\n\t\t\t// Subdomain style: https://<bucket>.storage.googleapis.com/<object>\n\t\t\tbucketName = url.hostname.replace(\".storage.googleapis.com\", \"\")\n\t\t\tobjectPath = url.pathname.replace(/^\\/+/, \"\")\n\t\t} else if (url.hostname === \"storage.googleapis.com\") {\n\t\t\t// Path style: https://storage.googleapis.com/<bucket>/<object>\n\t\t\tconst segments = url.pathname.split(\"/\").filter(Boolean)\n\t\t\tif (!segments[0]) {\n\t\t\t\treturn null\n\t\t\t}\n\t\t\tbucketName = segments[0]\n\t\t\tobjectPath = segments.slice(1).join(\"/\")\n\t\t} else {\n\t\t\treturn null\n\t\t}\n\t\tlet decodedObjectPath = objectPath\n\t\ttry {\n\t\t\tdecodedObjectPath = decodeURIComponent(objectPath)\n\t\t} catch {\n\t\t\tdecodedObjectPath = objectPath\n\t\t}\n\t\treturn {\n\t\t\tbucketName: bucketName,\n\t\t\tfilePath: decodedObjectPath,\n\t\t}\n\t}\n\n\tstatic basePublicUrl(fileInfo: FileUriInfo): string {\n\t\treturn `https://${fileInfo.bucketName}.storage.googleapis.com`\n\t}\n\n\tstatic toPublicUrl(fileInfo: FileUriInfo): string {\n\t\treturn `https://${fileInfo.bucketName}.storage.googleapis.com/${fileInfo.filePath}`\n\t}\n\n\tstatic toGCSUri(fileInfo: FileUriInfo): string {\n\t\treturn `gs://${fileInfo.bucketName}/${fileInfo.filePath}`\n\t}\n}\n"]}