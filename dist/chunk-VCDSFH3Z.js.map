{"version":3,"sources":["../src/kms/client.ts"],"sourcesContent":["import crypto from \"node:crypto\"\n\nimport { KeyManagementServiceClient } from \"@google-cloud/kms\"\nimport { VError } from \"verror\"\n\nimport type { EncryptionResult, KMSClientConfig, KMSClientInterface } from \"./interfaces\"\n\n/**\n * Google Cloud KMS client for encryption and decryption operations\n */\nexport class KMSClient implements KMSClientInterface {\n\tprivate readonly client: KeyManagementServiceClient\n\tprivate readonly keyName: string\n\n\tconstructor(private readonly config: KMSClientConfig) {\n\t\tthis.client = new KeyManagementServiceClient()\n\t\tthis.keyName = this.client.cryptoKeyPath(\n\t\t\tthis.config.project,\n\t\t\tthis.config.location,\n\t\t\tthis.config.keyRing,\n\t\t\tthis.config.key,\n\t\t)\n\t}\n\n\t/**\n\t * Encrypts plaintext using Google Cloud KMS.\n\t * Ref: https://docs.cloud.google.com/kms/docs/encrypt-decrypt#kms-encrypt-symmetric-nodejs\n\t *\n\t * The encrypt() method automatically detects key type (CryptoKey or CryptoKeyVersion) and uses the appropriate method for encryption\n\t * - `CryptoKey`: Symmetric encryption with the primary key version\n\t * - `CryptoKeyVersion`: Asymmetric encryption with public key of the specified version\n\t */\n\tasync encrypt(plaintext: string, cryptoKeyVersion?: string): Promise<EncryptionResult> {\n\t\ttry {\n\t\t\tif (cryptoKeyVersion) {\n\t\t\t\treturn await this.encryptAsymmetric(plaintext, cryptoKeyVersion)\n\t\t\t}\n\n\t\t\tconst [encryptResponse] = await this.client.encrypt({\n\t\t\t\tname: this.keyName,\n\t\t\t\tplaintext: Buffer.from(plaintext),\n\t\t\t})\n\n\t\t\tif (!encryptResponse?.ciphertext || !encryptResponse.name) {\n\t\t\t\tthrow new VError(\"Not all required fields returned from KMS\")\n\t\t\t}\n\n\t\t\t// Extract crypto key version from the response name\n\t\t\tconst nameparts = encryptResponse.name.split(\"/\")\n\t\t\tconst version = nameparts[nameparts.length - 1]\n\n\t\t\tif (!version) {\n\t\t\t\tthrow new VError(\"No crypto key version returned from KMS\")\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tciphertext: Buffer.from(encryptResponse.ciphertext).toString(\"base64\"),\n\t\t\t\tcryptoKeyVersion: version,\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tif (error instanceof VError) throw error\n\t\t\tthrow new VError(error as Error, \"Failed to encrypt with KMS\")\n\t\t}\n\t}\n\n\t/**\n\t * Encrypts plaintext using Google Cloud KMS with asymmetric key (public key).\n\t * Ref: https://docs.cloud.google.com/kms/docs/encrypt-decrypt-rsa#kms-encrypt-asymmetric-nodejs\n\t */\n\tasync encryptAsymmetric(plaintext: string, cryptoKeyVersion: string): Promise<EncryptionResult> {\n\t\ttry {\n\t\t\tconst keyVersionName = this.client.cryptoKeyVersionPath(\n\t\t\t\tthis.config.project,\n\t\t\t\tthis.config.location,\n\t\t\t\tthis.config.keyRing,\n\t\t\t\tthis.config.key,\n\t\t\t\tcryptoKeyVersion,\n\t\t\t)\n\n\t\t\tconst [publicKey] = await this.client.getPublicKey({ name: keyVersionName })\n\t\t\tif (!publicKey.pem) {\n\t\t\t\tthrow new VError(\"Public key PEM not found from KMS\")\n\t\t\t}\n\n\t\t\t// Map KMS algorithm to Node.js crypto parameters\n\t\t\tconst algorithm = publicKey.algorithm?.toString() || \"\"\n\t\t\tconst hash = algorithm.includes(\"SHA512\") ? \"sha512\" : \"sha256\"\n\n\t\t\tconst ciphertext = crypto.publicEncrypt(\n\t\t\t\t{\n\t\t\t\t\tkey: publicKey.pem,\n\t\t\t\t\tpadding: crypto.constants.RSA_PKCS1_OAEP_PADDING,\n\t\t\t\t\toaepHash: hash,\n\t\t\t\t},\n\t\t\t\tBuffer.from(plaintext),\n\t\t\t)\n\n\t\t\treturn {\n\t\t\t\tciphertext: ciphertext.toString(\"base64\"),\n\t\t\t\tcryptoKeyVersion,\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthrow new VError(error as Error, \"Failed to encrypt asymmetrically with KMS\")\n\t\t}\n\t}\n\n\t/**\n\t * Decrypts ciphertext using Google Cloud KMS\n\t * Ref: https://docs.cloud.google.com/kms/docs/encrypt-decrypt#kms-decrypt-symmetric-nodejs\n\t */\n\tasync decrypt(ciphertext: string): Promise<string> {\n\t\ttry {\n\t\t\tconst ciphertextBuffer = Buffer.from(ciphertext, \"base64\")\n\t\t\tconst [decryptResponse] = await this.client.decrypt({\n\t\t\t\tname: this.keyName,\n\t\t\t\tciphertext: ciphertextBuffer,\n\t\t\t})\n\n\t\t\tif (!decryptResponse.plaintext) {\n\t\t\t\tthrow new VError(\"No plaintext returned from KMS\")\n\t\t\t}\n\n\t\t\treturn Buffer.from(decryptResponse.plaintext).toString()\n\t\t} catch (error) {\n\t\t\tthrow new VError(error as Error, \"Failed to decrypt with KMS\")\n\t\t}\n\t}\n\n\t/**\n\t * Decrypts ciphertext using Google Cloud KMS with asymmetric key\n\t * Note: Asymmetric decryption requires specifying the exact key version used for encryption\n\t * Ref: https://docs.cloud.google.com/kms/docs/encrypt-decrypt-rsa#kms-decrypt-asymmetric-nodejs\n\t */\n\tasync decryptAsymmetric(ciphertext: string, cryptoKeyVersion: string): Promise<string> {\n\t\ttry {\n\t\t\tconst ciphertextBuffer = Buffer.from(ciphertext, \"base64\")\n\n\t\t\tconst keyName = this.client.cryptoKeyVersionPath(\n\t\t\t\tthis.config.project,\n\t\t\t\tthis.config.location,\n\t\t\t\tthis.config.keyRing,\n\t\t\t\tthis.config.key,\n\t\t\t\tcryptoKeyVersion,\n\t\t\t)\n\n\t\t\tconst [decryptResponse] = await this.client.asymmetricDecrypt({\n\t\t\t\tname: keyName,\n\t\t\t\tciphertext: ciphertextBuffer,\n\t\t\t})\n\n\t\t\tif (!decryptResponse.plaintext) {\n\t\t\t\tthrow new VError(\"No plaintext returned from KMS\")\n\t\t\t}\n\n\t\t\treturn Buffer.from(decryptResponse.plaintext).toString()\n\t\t} catch (error) {\n\t\t\tthrow new VError(error as Error, \"Failed to decrypt asymmetrically with KMS\")\n\t\t}\n\t}\n\n\t/**\n\t * Closes the KMS client connection\n\t */\n\tasync close(): Promise<void> {\n\t\tawait this.client.close()\n\t}\n}\n"],"mappings":"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","names":[]}